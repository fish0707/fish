<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotebookLM æ™ºæ…§æ¸¬é©—ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <div id="app" class="flex flex-col items-center justify-center min-h-screen p-4"></div>

    <script>
        // ==========================================
        // è¨­å®šå€åŸŸ
        // ==========================================
        // è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwBS1cRZVuZZpbVpOfgs_Yg38liCu4u9Eyg58MTY0J0mRFqUklmmzwGkYALcEU2JTweKw/exec";
        const USE_MOCK_DATA = false;

        const MOCK_DATA = [
            { id: 1, question: "ç¯„ä¾‹ï¼šReact Hook?", options: ["useState", "class"], correctAnswer: "useState", explanation: "Mock data explanation." },
            { id: 2, question: "ç¯„ä¾‹ï¼šFetch?", options: ["Yes", "No"], correctAnswer: "Yes", explanation: "Mock data explanation." }
        ];

        let state = {
            view: 'welcome',
            userName: '',
            questions: [],
            currentQuestionIndex: 0,
            userAnswers: {},
            score: 0,
            errorMsg: ''
        };

        // ==========================================
        // æ ¸å¿ƒé‚è¼¯
        // ==========================================
        function shuffleArray(array) {
            let newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // æ–°å¢ï¼šæ™ºæ…§æ¯”å°å‡½å¼ (è§£æ±º 0 åˆ†å•é¡Œçš„æ ¸å¿ƒ)
        function checkAnswer(q, userAnswer) {
            // 1. è‹¥ç„¡ä½œç­”å‰‡éŒ¯
            if (!userAnswer) return false;
            
            // 2. æ¨™æº–æ¯”å° (æ–‡å­—å®Œå…¨ç›¸åŒ)
            // è½‰æˆå­—ä¸²ä¸¦å»é™¤ç©ºç™½ï¼Œé¿å…å› ç‚ºå¤šä¸€å€‹ç©ºç™½è€Œç®—éŒ¯
            const ansStr = String(userAnswer).trim();
            const correctStr = String(q.correctAnswer).trim();
            if (ansStr === correctStr) return true;

            // 3. ä»£è™Ÿæ¯”å° (å¦‚æœå¾Œç«¯çµ¦çš„æ˜¯ A, B, C... ä½†å‰ç«¯æ˜¯é¸é …æ–‡å­—)
            // å˜—è©¦è§£æå¾Œç«¯çµ¦çš„æ­£ç¢ºç­”æ¡ˆæ˜¯å¦ç‚ºä»£è™Ÿ
            const upperCorrect = correctStr.toUpperCase();
            // è™•ç†å¸¸è¦‹æ ¼å¼: A, (A), A., Option A
            let optionIndex = -1;
            
            if (["A", "(A)", "A.", "OPTION A"].includes(upperCorrect)) optionIndex = 0;
            else if (["B", "(B)", "B.", "OPTION B"].includes(upperCorrect)) optionIndex = 1;
            else if (["C", "(C)", "C.", "OPTION C"].includes(upperCorrect)) optionIndex = 2;
            else if (["D", "(D)", "D.", "OPTION D"].includes(upperCorrect)) optionIndex = 3;
            
            // å¦‚æœæ­£ç¢ºç­”æ¡ˆæ˜¯ A/B/C/Dï¼Œä¸”å°æ‡‰çš„é¸é …æ–‡å­—ç­‰æ–¼ä½¿ç”¨è€…çš„ç­”æ¡ˆï¼Œå‰‡ç®—å°
            if (optionIndex !== -1 && q.options[optionIndex]) {
                 if (String(q.options[optionIndex]).trim() === ansStr) return true;
            }

            return false;
        }

        function handleStart() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            if (!name) { alert('è«‹è¼¸å…¥æ‚¨çš„å§“å'); return; }
            state.userName = name;
            fetchQuestions();
        }

        async function fetchQuestions() {
            renderLoading();
            if (!USE_MOCK_DATA && (GAS_URL.includes("YOUR_GOOGLE") || GAS_URL === "")) {
                state.errorMsg = "å°šæœªè¨­å®š GAS_URL"; renderError(); return;
            }
            try {
                let data = [];
                if (USE_MOCK_DATA) {
                    await new Promise(r => setTimeout(r, 800)); data = MOCK_DATA;
                } else {
                    const response = await fetch(GAS_URL);
                    const text = await response.text();
                    try { data = JSON.parse(text); } catch (e) { throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–æ¬Šé™ä¸è¶³"); }
                }
                if (!Array.isArray(data) || data.length === 0) throw new Error("ç„¡é¡Œç›®è³‡æ–™");
                state.questions = shuffleArray(data);
                state.view = 'quiz';
                renderQuiz();
            } catch (err) {
                state.errorMsg = err.message || "æœªçŸ¥éŒ¯èª¤"; renderError();
            }
        }

        function selectAnswer(option) {
            const currentQ = state.questions[state.currentQuestionIndex];
            state.userAnswers[currentQ.id] = option;
            renderQuiz();
        }

        function handleNext() {
            if (state.currentQuestionIndex < state.questions.length - 1) {
                state.currentQuestionIndex++;
                renderQuiz();
            } else {
                calculateAndSubmit();
            }
        }

        // ä¿®æ”¹ï¼šè¨ˆç®—åˆ†æ•¸ä¸¦æ”¶é›†éŒ¯é¡Œ (ä½¿ç”¨ checkAnswer åŠ å¼·æº–ç¢ºåº¦)
        async function calculateAndSubmit() {
            let correctCount = 0;
            let wrongQuestionsLog = []; // ç”¨ä¾†å­˜éŒ¯é¡Œè³‡è¨Š

            state.questions.forEach(q => {
                const userAnswer = state.userAnswers[q.id];
                // ä½¿ç”¨æ™ºæ…§æ¯”å°
                const isCorrect = checkAnswer(q, userAnswer);

                if (isCorrect) {
                    correctCount++;
                } else {
                    // ç´€éŒ„éŒ¯é¡Œï¼šä½¿ç”¨ String() å¼·åˆ¶è½‰å‹ï¼Œé˜²æ­¢é¡Œç›®éæ–‡å­—å°è‡´å ±éŒ¯
                    const qText = String(q.question || "ç„¡é¡Œç›®å…§å®¹");
                    // å–å‰ 15 å€‹å­—ï¼Œä¸¦æŠŠé€—è™Ÿæ›æˆå…¨å½¢ï¼Œé¿å… CSV æ ¼å¼éŒ¯äº‚
                    let shortQ = qText.substring(0, 15).replace(/,/g, "ï¼Œ"); 
                    wrongQuestionsLog.push(`[${q.id}]${shortQ}...`);
                }
            });

            state.score = Math.round((correctCount / state.questions.length) * 100);
            
            // å°‡éŒ¯é¡Œé™£åˆ—è½‰æˆå­—ä¸²
            let wrongListStr = wrongQuestionsLog.join(", ");

            state.view = 'submitting';
            renderLoading('æ­£åœ¨å„²å­˜æˆç¸¾...');

            if (!USE_MOCK_DATA) {
                try {
                    await fetch(GAS_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            name: state.userName,
                            score: state.score,
                            wrongList: wrongListStr // æ–°å¢é€™å€‹æ¬„ä½å‚³çµ¦å¾Œç«¯
                        })
                    });
                } catch (e) { console.error("æäº¤å¤±æ•—", e); }
            } else { await new Promise(r => setTimeout(r, 1000)); }

            state.view = 'result';
            renderResult();
        }

        function restart() {
            state.userName = ''; state.currentQuestionIndex = 0;
            state.userAnswers = {}; state.score = 0;
            state.view = 'welcome'; renderWelcome();
        }

        // ==========================================
        // ç•«é¢æ¸²æŸ“
        // ==========================================
        const app = document.getElementById('app');

        function renderWelcome() {
            app.innerHTML = `
                <div class="bg-white max-w-md w-full rounded-2xl shadow-xl overflow-hidden fade-in">
                    <div class="bg-blue-600 p-8 text-center text-white">
                        <h1 class="text-3xl font-bold mb-2">ç·šä¸Šæ¸¬é©—ç³»çµ±</h1>
                        <p class="text-blue-100">NotebookLM æ™ºæ…§å‡ºé¡Œ</p>
                    </div>
                    <div class="p-8 space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">è«‹è¼¸å…¥æ‚¨çš„å§“å</label>
                            <input type="text" id="nameInput" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: ç‹å°æ˜">
                        </div>
                        <button onclick="handleStart()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition shadow-lg">é–‹å§‹æ¸¬é©—</button>
                    </div>
                </div>`;
        }

        function renderLoading(msg = 'è¼‰å…¥ä¸­...') {
            app.innerHTML = `<div class="flex flex-col items-center fade-in"><div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-slate-600">${msg}</p></div>`;
        }

        function renderError() {
            app.innerHTML = `<div class="bg-white p-8 rounded-2xl shadow-xl border-l-4 border-red-500 fade-in"><h2 class="text-xl font-bold text-red-600 mb-4">ç™¼ç”ŸéŒ¯èª¤</h2><p class="text-red-800 mb-6">${state.errorMsg}</p><button onclick="restart()" class="w-full bg-slate-900 text-white py-3 rounded-lg">é‡æ–°æ•´ç†</button></div>`;
        }

        function renderQuiz() {
            const currentQ = state.questions[state.currentQuestionIndex];
            const progress = Math.round(((state.currentQuestionIndex + 1) / state.questions.length) * 100);
            const isAnswered = state.userAnswers[currentQ.id] !== undefined;

            const optionsHtml = currentQ.options.map((option, idx) => {
                const isSelected = state.userAnswers[currentQ.id] === option;
                const baseClass = "w-full text-left p-4 rounded-xl border-2 transition flex items-center mb-3 ";
                const colorClass = isSelected ? 'border-blue-500 bg-blue-50 text-blue-800' : 'border-slate-100 hover:border-blue-200 hover:bg-slate-50 text-slate-600';
                return `<button onclick="selectAnswer('${option}')" class="${baseClass} ${colorClass}"><span class="w-8 h-8 flex items-center justify-center rounded-full text-sm font-bold mr-3 ${isSelected ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}">${String.fromCharCode(65 + idx)}</span><span class="font-medium text-lg">${option}</span></button>`;
            }).join('');

            app.innerHTML = `
                <div class="w-full max-w-2xl fade-in">
                    <div class="mb-6 flex justify-between text-sm text-slate-500"><span>Question ${state.currentQuestionIndex + 1}/${state.questions.length}</span><span>${progress}%</span></div>
                    <div class="h-2.5 bg-slate-200 rounded-full mb-6 overflow-hidden"><div class="h-full bg-blue-600 transition-all duration-500" style="width: ${progress}%"></div></div>
                    <div class="bg-white rounded-2xl shadow-sm border p-6 mb-6"><h2 class="text-xl font-bold mb-8">${currentQ.question}</h2><div class="space-y-3">${optionsHtml}</div></div>
                    <div class="flex justify-end"><button onclick="handleNext()" ${!isAnswered ? 'disabled' : ''} class="px-8 py-3 rounded-lg font-bold text-lg transition ${isAnswered ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg' : 'bg-slate-200 text-slate-400'}">${state.currentQuestionIndex === state.questions.length - 1 ? 'æäº¤è©¦å·' : 'ä¸‹ä¸€é¡Œ'}</button></div>
                </div>`;
        }

        function renderResult() {
            const reviewHtml = state.questions.map((q, idx) => {
                // ä½¿ç”¨ checkAnswer ä¾†æ±ºå®šé¡¯ç¤ºç¶ è‰²é‚„ç´…è‰²
                const isCorrect = checkAnswer(q, state.userAnswers[q.id]);
                
                let explanationHtml = '';
                if (!isCorrect && q.explanation) explanationHtml = `<div class="mt-2 bg-amber-50 rounded-xl p-5 border border-amber-100"><h5 class="text-amber-800 font-bold text-sm mb-2">NotebookLM æŒ‡å°</h5><p class="text-slate-700 text-sm">${q.explanation}</p></div>`;
                else if (isCorrect && q.explanation) explanationHtml = `<div class="mt-2 text-slate-500 text-sm italic pl-1">ğŸ’¡ ${q.explanation}</div>`;

                return `<div class="bg-white rounded-xl shadow-sm border mb-6 overflow-hidden"><div class="p-6 border-l-[6px] ${isCorrect ? 'border-green-500' : 'border-red-500'}"><h4 class="text-lg font-bold mb-4">Q${idx + 1}. ${q.question}</h4><div class="flex gap-4 text-sm mb-4"><span class="${isCorrect ? 'text-green-700' : 'text-red-700'} font-bold">ä½ çš„ç­”æ¡ˆ: ${state.userAnswers[q.id] || "æœªä½œç­”"}</span>${!isCorrect ? `<span class="text-slate-600">æ­£ç¢ºç­”æ¡ˆ: ${q.correctAnswer}</span>` : ''}</div>${explanationHtml}</div></div>`;
            }).join('');

            app.innerHTML = `
                <div class="w-full max-w-3xl fade-in">
                    <div class="bg-white rounded-2xl shadow-lg border p-8 text-center mb-8"><h2 class="text-3xl font-bold mb-2">æ¸¬é©—å®Œæˆ</h2><p class="text-slate-500 mb-4">${state.userName} çš„æˆç¸¾</p><div class="text-6xl font-black text-slate-800 mb-6">${state.score}</div><button onclick="restart()" class="text-blue-600 font-bold hover:underline">é‡æ–°æ¸¬é©—</button></div>
                    <div class="space-y-6">${reviewHtml}</div>
                </div>`;
        }

        renderWelcome();
    </script>
</body>
</html>
