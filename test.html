import React, { useState, useEffect } from 'react';
import { Loader2, CheckCircle2, XCircle, Award, ArrowRight, RefreshCcw, BookOpen, AlertTriangle } from 'lucide-react';

// --- è¨­å®šå€åŸŸ ---
// 1. éƒ¨ç½²æ™‚è«‹ç¢ºèªæ­¤è™•ç‚º falseï¼Œæ‰æœƒæŠ“å– Google Sheet è³‡æ–™
const USE_MOCK_DATA = false; 

// 2. è«‹å¡«å…¥æ‚¨éƒ¨ç½²å¥½çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (Exec URL)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBS1cRZVuZZpbVpOfgs_Yg38liCu4u9Eyg58MTY0J0mRFqUklmmzwGkYALcEU2JTweKw/exec";

const MOCK_QUESTIONS = [
  {
    id: 1,
    question: "åœ¨ React ä¸­ï¼Œç”¨æ–¼ç®¡ç†çµ„ä»¶å…§éƒ¨ç‹€æ…‹çš„ Hook æ˜¯ä»€éº¼ï¼Ÿ",
    options: ["useEffect", "useState", "useContext", "useReducer"],
    correctAnswer: "useState",
    explanation: "NotebookLM è§£æï¼šuseState æ˜¯ React ä¸­æœ€åŸºç¤çš„ Hookï¼Œå…è¨±å‡½æ•¸çµ„ä»¶æ“æœ‰è‡ªå·±çš„ç‹€æ…‹ã€‚useEffect å‰‡æ˜¯ç”¨æ–¼è™•ç†å‰¯ä½œç”¨ã€‚"
  },
  {
    id: 2,
    question: "CSS ä¸­ï¼Œå“ªä¸€å€‹å±¬æ€§å¯ä»¥æ”¹è®Šå…ƒç´ çš„èƒŒæ™¯é¡è‰²ï¼Ÿ",
    options: ["color", "background-color", "border-color", "fill"],
    correctAnswer: "background-color",
    explanation: "NotebookLM è§£æï¼šcolor å±¬æ€§é€šå¸¸ç”¨æ–¼æ”¹è®Šæ–‡å­—é¡è‰²ï¼Œè€Œ background-color æ‰æ˜¯å°ˆé–€ç”¨æ–¼è¨­å®šå…ƒç´ èƒŒæ™¯è‰²çš„å±¬æ€§ã€‚"
  },
  {
    id: 3,
    question: "ä¸‹åˆ—ä½•è€…ä¸æ˜¯ JavaScript çš„è³‡æ–™å‹åˆ¥ï¼Ÿ",
    options: ["String", "Boolean", "Float", "Undefined"],
    correctAnswer: "Float",
    explanation: "NotebookLM è§£æï¼šJavaScript åªæœ‰ Number å‹åˆ¥ï¼Œä¸å€åˆ† Integer æˆ– Floatã€‚å…¶ä»–é¸é …çš†ç‚º JS çš„åŸºæœ¬å‹åˆ¥ã€‚"
  }
];

export default function App() {
  const [appState, setAppState] = useState('welcome'); // welcome, loading, quiz, result, submitting
  const [userName, setUserName] = useState('');
  const [questions, setQuestions] = useState([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [userAnswers, setUserAnswers] = useState({}); // { questionId: selectedOption }
  const [score, setScore] = useState(0);

  // æ´—ç‰Œæ¼”ç®—æ³• (Fisher-Yates Shuffle)
  const shuffleArray = (array) => {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
  };

  // æŠ“å–é¡Œç›®
  const fetchQuestions = async () => {
    // é˜²å‘†æª¢æŸ¥ï¼šç¢ºèªæ˜¯å¦å·²è¨­å®š URL
    if (!USE_MOCK_DATA && GOOGLE_SCRIPT_URL.includes("YOUR_GOOGLE_APPS_SCRIPT")) {
      alert("å°šæœªè¨­å®šå¾Œç«¯ç¶²å€ï¼\nè«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Google Apps Script URLã€‚");
      return;
    }

    setAppState('loading');
    try {
      let data = [];
      if (USE_MOCK_DATA) {
        // æ¨¡æ“¬å»¶é²
        await new Promise(resolve => setTimeout(resolve, 1000));
        data = MOCK_QUESTIONS;
      } else {
        const response = await fetch(GOOGLE_SCRIPT_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        data = await response.json();
      }
      
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error('No questions found');
      }

      // éš¨æ©Ÿæ’åºé¡Œç›®
      setQuestions(shuffleArray(data));
      setAppState('quiz');
    } catch (error) {
      console.error("Failed to fetch questions", error);
      alert("è®€å–é¡Œç›®å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ– Google Sheet è¨­å®šã€‚\n(å¦‚æœæ˜¯è·¨åŸŸå•é¡Œï¼Œè«‹ç¢ºèª Apps Script å·²è¨­ç‚º 'ä»»ä½•äºº' å¯å­˜å–)");
      setAppState('welcome');
    }
  };

  // è™•ç†é–‹å§‹æ¸¬é©—
  const handleStart = () => {
    if (!userName.trim()) {
      alert("è«‹è¼¸å…¥æ‚¨çš„å§“å");
      return;
    }
    fetchQuestions();
  };

  // è™•ç†é¸æ“‡ç­”æ¡ˆ
  const handleAnswerSelect = (option) => {
    setUserAnswers({
      ...userAnswers,
      [questions[currentQuestionIndex].id]: option
    });
  };

  // ä¸‹ä¸€é¡Œæˆ–çµæŸ
  const handleNext = () => {
    if (currentQuestionIndex < questions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
    } else {
      calculateScore();
    }
  };

  // è¨ˆç®—åˆ†æ•¸ä¸¦æäº¤
  const calculateScore = async () => {
    let currentScore = 0;
    questions.forEach(q => {
      if (userAnswers[q.id] === q.correctAnswer) {
        currentScore += 1;
      }
    });
    
    const finalScore = Math.round((currentScore / questions.length) * 100);
    setScore(finalScore);
    setAppState('submitting');

    // æäº¤æˆç¸¾å› Google Sheet
    if (!USE_MOCK_DATA && !GOOGLE_SCRIPT_URL.includes("YOUR_GOOGLE_APPS_SCRIPT")) {
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ name: userName, score: finalScore }),
          // no-cors æ¨¡å¼å°æ–¼ Google Apps Script æ˜¯å¿…é ˆçš„ï¼Œä½†å®ƒä¸æœƒå›å‚³å¯è®€çš„ response
          mode: 'no-cors', 
          headers: { 'Content-Type': 'application/json' }
        });
      } catch (error) {
        console.error("Submission error", error);
        // å³ä½¿æäº¤å¤±æ•—ï¼Œä¹Ÿè®“ä½¿ç”¨è€…çœ‹æˆç¸¾ï¼Œä¸é˜»æ“‹æµç¨‹
      }
    } else {
      await new Promise(resolve => setTimeout(resolve, 800));
    }
    
    setAppState('result');
  };

  const restartQuiz = () => {
    setAppState('welcome');
    setUserName('');
    setUserAnswers({});
    setCurrentQuestionIndex(0);
    setScore(0);
  };

  // --- ç•«é¢çµ„ä»¶ ---

  // 1. æ­¡è¿ç•«é¢
  if (appState === 'welcome') {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
        <div className="bg-white max-w-md w-full rounded-2xl shadow-xl overflow-hidden">
          <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-8 text-center">
            <BookOpen className="w-16 h-16 text-white/90 mx-auto mb-4" />
            <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">ç·šä¸Šæ¸¬é©—ç³»çµ±</h1>
            <p className="text-blue-100 font-medium">æŒ‘æˆ°è‡ªæˆ‘ï¼Œç²å– AI æ™ºæ…§æŒ‡å°</p>
          </div>
          <div className="p-8 space-y-6">
            <div>
              <label className="block text-sm font-semibold text-slate-700 mb-2">
                è«‹è¼¸å…¥æ‚¨çš„å§“å
              </label>
              <input
                type="text"
                value={userName}
                onChange={(e) => setUserName(e.target.value)}
                className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition placeholder:text-slate-400"
                placeholder="Ex: ç‹å°æ˜"
              />
            </div>
            
            {/* æç¤ºä½¿ç”¨è€…è¨­å®š URL çš„å€å¡Š (è‹¥ URL æœªè¨­å®šæœƒé¡¯ç¤º) */}
            {!USE_MOCK_DATA && GOOGLE_SCRIPT_URL.includes("YOUR_GOOGLE_APPS_SCRIPT") && (
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 flex gap-3 text-sm text-amber-800">
                <AlertTriangle className="w-5 h-5 shrink-0" />
                <div>
                  <span className="font-bold">å°šæœªè¨­å®šå¾Œç«¯ï¼š</span>
                  è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Google Apps Script URL æ‰èƒ½é–‹å§‹æ¸¬é©—ã€‚
                </div>
              </div>
            )}

            <button
              onClick={handleStart}
              className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform active:scale-95"
            >
              é–‹å§‹æ¸¬é©— <ArrowRight className="w-4 h-4" />
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 2. è¼‰å…¥ä¸­
  if (appState === 'loading' || appState === 'submitting') {
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center">
        <Loader2 className="w-12 h-12 text-blue-600 animate-spin mb-4" />
        <p className="text-slate-600 font-medium animate-pulse">
          {appState === 'loading' ? 'æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è©¦é¡Œ...' : 'æ­£åœ¨ç´€éŒ„æˆç¸¾...'}
        </p>
      </div>
    );
  }

  // 3. æ¸¬é©—ç•«é¢
  if (appState === 'quiz') {
    const currentQ = questions[currentQuestionIndex];
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    const isAnswered = userAnswers[currentQ.id] !== undefined;

    return (
      <div className="min-h-screen bg-slate-50 py-8 px-4 flex justify-center font-sans">
        <div className="w-full max-w-2xl">
          {/* é€²åº¦æ¢ */}
          <div className="mb-6">
            <div className="flex justify-between text-sm text-slate-500 mb-2 font-medium">
              <span>Question {currentQuestionIndex + 1} <span className="text-slate-300">/</span> {questions.length}</span>
              <span>{Math.round(progress)}%</span>
            </div>
            <div className="h-2.5 bg-slate-200 rounded-full overflow-hidden">
              <div 
                className="h-full bg-blue-600 transition-all duration-500 ease-out rounded-full"
                style={{ width: `${progress}%` }}
              ></div>
            </div>
          </div>

          {/* é¡Œç›®å¡ç‰‡ */}
          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 mb-6">
            <h2 className="text-xl md:text-2xl font-bold text-slate-800 mb-8 leading-relaxed">
              {currentQ.question}
            </h2>

            <div className="space-y-3">
              {currentQ.options.map((option, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswerSelect(option)}
                  className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center group ${
                    userAnswers[currentQ.id] === option
                      ? 'border-blue-500 bg-blue-50 text-blue-800'
                      : 'border-slate-100 hover:border-blue-200 hover:bg-slate-50 text-slate-600'
                  }`}
                >
                  <span className={`flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold mr-3 transition-colors ${
                    userAnswers[currentQ.id] === option
                      ? 'bg-blue-600 text-white'
                      : 'bg-slate-100 text-slate-400 group-hover:bg-blue-100 group-hover:text-blue-600'
                  }`}>
                    {String.fromCharCode(65 + idx)}
                  </span>
                  <span className="font-medium text-lg">{option}</span>
                </button>
              ))}
            </div>
          </div>

          <div className="flex justify-end">
            <button
              onClick={handleNext}
              disabled={!isAnswered}
              className={`px-8 py-3 rounded-lg font-bold text-lg transition-all transform ${
                isAnswered
                  ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl hover:-translate-y-0.5'
                  : 'bg-slate-200 text-slate-400 cursor-not-allowed'
              }`}
            >
              {currentQuestionIndex === questions.length - 1 ? 'æäº¤è©¦å·' : 'ä¸‹ä¸€é¡Œ'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 4. çµæœç•«é¢ (é‡é»ï¼šé¡¯ç¤º NotebookLM çš„æŒ‡å°)
  if (appState === 'result') {
    return (
      <div className="min-h-screen bg-slate-50 py-8 px-4 flex justify-center font-sans">
        <div className="w-full max-w-3xl">
          
          {/* æˆç¸¾çœ‹æ¿ */}
          <div className="bg-white rounded-2xl shadow-lg border border-slate-100 p-8 text-center mb-8 relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
            <div className="inline-flex items-center justify-center w-24 h-24 bg-yellow-50 rounded-full mb-4 ring-8 ring-yellow-50/50">
              <Award className="w-12 h-12 text-yellow-500" />
            </div>
            <h2 className="text-3xl font-bold text-slate-800 mb-2">æ¸¬é©—å®Œæˆï¼</h2>
            <p className="text-slate-500 mb-6 font-medium text-lg">{userName} çš„æœ€çµ‚æˆç¸¾</p>
            <div className="text-7xl font-black text-slate-800 mb-8 tracking-tighter">
              {score}<span className="text-3xl text-slate-400 font-normal ml-1">/100</span>
            </div>
            <button
              onClick={restartQuiz}
              className="inline-flex items-center gap-2 text-slate-600 hover:text-blue-600 font-bold transition-colors py-2 px-4 rounded-lg hover:bg-slate-50"
            >
              <RefreshCcw className="w-5 h-5" /> é‡æ–°æ¸¬é©—
            </button>
          </div>

          {/* è©³ç´°è§£æå€åŸŸ */}
          <div className="space-y-6">
            <div className="flex items-center gap-3 ml-1 mb-2">
              <div className="w-1 h-6 bg-blue-600 rounded-full"></div>
              <h3 className="text-xl font-bold text-slate-800">è©³ç´°è§£æèˆ‡æŒ‡å°</h3>
            </div>
            
            {questions.map((q, idx) => {
              const userAnswer = userAnswers[q.id];
              const isCorrect = userAnswer === q.correctAnswer;

              return (
                <div key={q.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition hover:shadow-md">
                  <div className={`p-6 border-l-[6px] ${isCorrect ? 'border-green-500' : 'border-red-500'}`}>
                    <div className="flex items-start gap-4">
                      <div className="mt-1 shrink-0">
                        {isCorrect ? (
                          <CheckCircle2 className="w-7 h-7 text-green-500" />
                        ) : (
                          <XCircle className="w-7 h-7 text-red-500" />
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">
                          Question {idx + 1}
                        </span>
                        <h4 className="text-lg font-bold text-slate-800 mb-4 leading-snug">
                          {q.question}
                        </h4>
                        
                        <div className="flex flex-col sm:flex-row gap-3 text-sm mb-5 bg-slate-50 p-3 rounded-lg">
                          <div className={`flex items-center gap-2 ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                            <span className="font-bold shrink-0">ä½ çš„ç­”æ¡ˆ:</span> 
                            <span className="font-mono">{userAnswer}</span>
                          </div>
                          {!isCorrect && (
                            <div className="flex items-center gap-2 text-slate-700">
                              <span className="font-bold shrink-0">æ­£ç¢ºç­”æ¡ˆ:</span> 
                              <span className="font-mono text-green-700">{q.correctAnswer}</span>
                            </div>
                          )}
                        </div>

                        {/* é€™è£¡é¡¯ç¤º NotebookLM çš„æŒ‡å°å…§å®¹ */}
                        {!isCorrect && q.explanation && (
                          <div className="mt-2 bg-gradient-to-br from-amber-50 to-orange-50/50 rounded-xl p-5 border border-amber-100 shadow-sm">
                            <h5 className="text-amber-700 font-bold text-sm mb-3 flex items-center gap-2 uppercase tracking-wide">
                              <BookOpen className="w-4 h-4" />
                              NotebookLM æ™ºæ…§æŒ‡å°
                            </h5>
                            <p className="text-slate-700 text-sm leading-7 text-justify">
                              {q.explanation}
                            </p>
                          </div>
                        )}
                        
                        {/* å³ä½¿ç­”å°ä¹Ÿå¯ä»¥é¡¯ç¤ºè§£æ (å¯é¸) */}
                        {isCorrect && q.explanation && (
                           <div className="mt-2 text-slate-500 text-sm italic pl-1">
                             <p>ğŸ’¡ {q.explanation}</p>
                           </div>
                        )}

                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  return null;
}
