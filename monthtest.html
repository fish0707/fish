<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>月份異動申請書 - 送出表單</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans TC",Arial;line-height:1.6;padding:20px;max-width:720px;margin:auto}
    label{display:block;margin:10px 0 4px}
    input,button{font-size:16px}
    input{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{color:#666;font-size:12px}
    .err{color:#c62828;margin:6px 0 0 0;font-size:13px;display:none}
    .ok{color:#2e7d32}
    button{margin-top:16px;padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    button[disabled]{opacity:.6;cursor:wait}
  </style>
</head>
<body>
  <h2>月份異動申請書</h2>

  <form id="form">
    <div class="row">
      <div>
        <label>客編（轉移者A）</label>
        <input id="custNo" required>
      </div>
      <div>
        <label>新客編（承接者B）</label>
        <input id="newCustNo">
      </div>
    </div>

    <div class="row">
      <div>
        <label>姓名（A）</label>
        <input id="name" required>
      </div>
      <div>
        <label>新姓名（B）</label>
        <input id="newName">
      </div>
    </div>

    <div class="row">
      <div>
        <label>地址（A）</label>
        <input id="addr">
      </div>
      <div>
        <label>新地址（B）</label>
        <input id="newAddr">
      </div>
    </div>

    <label>使用期間（自由輸入）</label>
    <input id="period" placeholder="例如：2025/08/01~2025/08/20 或 2025-08-01 ～ 2025/08/20" />
    <div class="hint">貼上即可；系統會自動解析並計算「轉移時間（天數）」與「轉移後到期日」。</div>
    <div id="periodErr" class="err">時間格式不正確，請用「YYYY/MM/DD ~ YYYY/MM/DD」</div>

    <div class="row">
      <div>
        <label>轉移時間（自動）</label>
        <input id="months" placeholder="例：19日" readonly>
      </div>
      <div>
        <label>轉移後到期日（自動）</label>
        <input id="expiry" placeholder="YYYY/MM/DD" readonly>
      </div>
    </div>

    <div class="row">
      <div>
        <label>經辦人</label>
        <input id="handler" placeholder="經辦人姓名">
      </div>
      <div>
        <label>客戶 Email</label>
        <input id="customerEmail" type="email" placeholder="name@example.com">
      </div>
    </div>

    <button id="submitBtn" type="submit">提交</button>
    <div id="msg" class="hint"></div>
  </form>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxlt2EHIr4rGPa9IKIOkuWjs-B-IhIMxfSxFLjuVisXcjqUYShu9d3a-QBGnKK18BGi/exec';

    // 工具：日期字串 → Date（以本地時區 00:00）
    function parseYMD(s){
      const m = String(s).trim().match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
      if(!m) return null;
      const y = +m[1], mo = +m[2]-1, d = +m[3];
      const dt = new Date(y, mo, d);
      return (dt.getFullYear()===y && dt.getMonth()===mo && dt.getDate()===d) ? dt : null;
    }
    function fmtYMD(d){const z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}`;}

    function parsePeriodToDates(periodStr){
      // 支援 ~、～、to、至，兩側可有空白
      const parts = String(periodStr).replace(/～/g,'~').replace(/至|to/gi,'~').split('~');
      if(parts.length!==2) return null;
      const s = parseYMD(parts[0]); const e = parseYMD(parts[1]);
      if(!s || !e || e < s) return null;
      return {start:s, end:e};
    }

    // 當「使用期間」變更時，自動帶出轉移時間/到期日
    const periodEl = document.getElementById('period');
    periodEl.addEventListener('change', handlePeriod);
    periodEl.addEventListener('blur', handlePeriod);
    function handlePeriod(){
      const box = parsePeriodToDates(periodEl.value);
      const err = document.getElementById('periodErr');
      if(!box){
        err.style.display = 'block';
        document.getElementById('months').value = '';
        document.getElementById('expiry').value = '';
        return;
      }
      err.style.display = 'none';
      const days = Math.round((box.end - box.start) / 86400000); // 以「天」差
      document.getElementById('months').value = `${days}日`;
      document.getElementById('expiry').value = fmtYMD(box.end);
    }

    // 送出
    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('msg');
      msg.textContent = '';

      // 驗證期間
      const range = parsePeriodToDates(document.getElementById('period').value);
      if(!range){ document.getElementById('periodErr').style.display='block'; return; }

      const payload = {
        '客編': document.getElementById('custNo').value.trim(),
        '姓名': document.getElementById('name').value.trim(),
        '地址': document.getElementById('addr').value.trim(),
        '新客編': document.getElementById('newCustNo').value.trim(),
        '新姓名': document.getElementById('newName').value.trim(),
        '新地址': document.getElementById('newAddr').value.trim(),
        '轉移區間': `${fmtYMD(range.start)}~${fmtYMD(range.end)}`,
        '轉移時間': document.getElementById('months').value.trim(),
        '轉移後到期日': document.getElementById('expiry').value.trim(),
        '經辦人': document.getElementById('handler').value.trim(),
        '客戶email': document.getElementById('customerEmail').value.trim()
      };

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = '送出中…';

      try{
        const resp = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        let ok = resp.ok, data = null;
        try{ data = await resp.json(); ok = data?.success ?? ok; }catch(_){}
        if(ok){ msg.innerHTML = '<span class="ok">提交成功！</span>'; }
        else{ throw new Error(data?.message || ('HTTP '+resp.status)); }
      }catch(err){
        // no-cors 後備
        try{
          await fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          msg.innerHTML = '<span class="ok">提交成功！（no-cors）</span>';
        }catch(e2){
          msg.innerHTML = '<span class="err" style="display:block">提交失敗：'+e2.message+'</span>';
        }
      }finally{
        btn.disabled = false; btn.textContent = '提交';
      }
    });
  </script>
</body>
</html>


