<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>客戶資料轉移系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f5ff; }
    .card { box-shadow: 0 4px 15px rgba(0,0,0,.1); transition: all .3s ease; }
    .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,.15); }
    .btn-primary { background-color: #3b82f6; transition: all .25s ease; }
    .btn-primary:hover { background-color: #2563eb; }
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;justify-content:center;align-items:center;z-index:9999}
    .loading-spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- 載入指示器 -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p id="loadingText" class="text-lg font-medium text-gray-700">正在處理，請稍候...</p>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-center text-gray-800">客戶資料轉移系統</h1>
      <p class="text-center text-gray-600 mt-2">將 A 客戶的使用權限轉移給 B 客戶</p>
    </header>

    <!-- 申請資訊 -->
    <div class="card bg-white rounded-lg p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">申請資訊</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-gray-700 mb-2">申請日期</label>
          <input type="date" id="applyDate" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>
    </div>

    <div id="inputForm">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- A客戶資料卡 -->
        <div class="card bg-white rounded-lg p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">A客戶資料（轉出方）</h2>
            <div class="flex items-center">
              <span id="customerAStatus" class="mr-2 hidden text-green-600">✓ 已載入</span>
              <button id="searchA" class="btn-primary text-white px-4 py-2 rounded-md">查詢客戶</button>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">客戶編號</label>
            <input type="text" id="customerA_id" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入客戶編號">
            <!-- 兩個 checkbox（A 客戶） -->
            <div class="mt-3 flex items-center gap-6">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="chkDeductReferral" class="w-4 h-4">
                <span class="text-gray-700">需扣除客介客（*）</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="chkSpecialCase" class="w-4 h-4">
                <span class="text-gray-700">特殊案件（^）</span>
              </label>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">姓名</label>
            <input type="text" id="customerA_name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入姓名">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">地址</label>
            <input type="text" id="customerA_address" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入地址">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">使用期限</label>
            <input type="date" id="customerA_expiry" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="mb-1">
            <label class="block text-gray-700 mb-2">剩餘天數</label>
            <input type="text" id="customerA_daysLeft" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="自動計算" readonly>
          </div>
        </div>

        <!-- B客戶資料卡 -->
        <div class="card bg-white rounded-lg p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">B客戶資料（接收方）</h2>
            <div class="flex items-center">
              <span id="customerBStatus" class="mr-2 hidden text-green-600">✓ 已載入</span>
              <button id="searchB" class="btn-primary text-white px-4 py-2 rounded-md">查詢客戶</button>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">客戶編號</label>
            <input type="text" id="customerB_id" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入客戶編號">
            <!-- 兩個 checkbox（B 客戶） -->
            <div class="mt-3 flex items-center gap-6">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="chkBDeductReferral" class="w-4 h-4">
                <span class="text-gray-700">需扣除客介客（*）</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="chkBSpecialCase" class="w-4 h-4">
                <span class="text-gray-700">特殊案件（^）</span>
              </label>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">姓名</label>
            <input type="text" id="customerB_name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入姓名">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">地址</label>
            <input type="text" id="customerB_address" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入地址">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">目前使用期限</label>
            <input type="date" id="customerB_currentExpiry" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="mb-1">
            <label class="block text-gray-700 mb-2">轉移後到期日</label>
            <input type="date" id="customerB_newExpiry" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
          </div>
        </div>
      </div>

      <!-- 轉移設定區域 -->
      <div class="card bg-white rounded-lg p-6 mt-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6">轉移設定</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-gray-700 mb-2">轉移日期</label>
            <input type="date" id="transferDate" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">轉移區間</label>
            <input type="text" id="transferPeriod" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="年/月/日~年/月/日" readonly>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
          <div>
            <label class="block text-gray-700 mb-2">轉移時間</label>
            <input type="text" id="transferDuration" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="幾個月幾日" readonly>
          </div>
          <div>
            <label class="block text-gray-700 mb-2">轉移天數</label>
            <input type="text" id="transferDays" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="總天數" readonly>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
          <div>
            <label class="block text-gray-700 mb-2">經辦人</label>
            <input type="text" id="handler" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入經辦人姓名">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">客戶 Email</label>
            <input type="email" id="customer_email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入客戶 Email">
          </div>
        </div>
      </div>

      <!-- 操作按鈕 -->
      <div class="flex justify-center mt-8">
        <button id="submitToGoogleBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md font-medium w-full max-w-xs">
          提交至 Google 試算表
        </button>
      </div>
    </div>
  </div>

  <script>
    // ====== Google Apps Script Web App URL ======
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxlt2EHIr4rGPa9IKIOkuWjs-B-IhIMxfSxFLjuVisXcjqUYShu9d3a-QBGnKK18BGi/exec';

    // ====== 模擬客戶資料庫（示例） ======
    const customerDatabase = {
      'A001': { name: '王小明', address: '台北市信義區信義路100號', expiry: '2025-12-31' },
      'A002': { name: '李小華', address: '台中市西屯區台灣大道200號', expiry: '2025-10-15' },
      'B001': { name: '張小美', address: '高雄市前鎮區中山路300號', expiry: '2025-11-06' },
      'B002': { name: '陳小強', address: '新北市板橋區文化路400號', expiry: '2025-09-10' }
    };

    // ====== 小工具 ======
    function daysBetween(d1, d2){const one=24*60*60*1000;return Math.round((new Date(d2)-new Date(d1))/one);}
    function addMonthsAndDays(date, months, days){const r=new Date(date);r.setMonth(r.getMonth()+months);r.setDate(r.getDate()+days);return r;}
    function formatDate(date){const d=new Date(date);const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${d.getFullYear()}-${m}-${day}`;}
    function formatDateSlash(date){const d=new Date(date);const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${d.getFullYear()}/${m}/${day}`;}
    function formatMonthsAndDays(m,d){if(m>0&&d>0)return `${m}個月${d}日`; if(m>0)return `${m}個月`; if(d>0)return `${d}日`; return '0日';}

    // === 30/360 月份分解 ===
    function isEndOfFeb(d){return d.getMonth()===1 && d.getDate()===new Date(d.getFullYear(),2,0).getDate();}
    function adjustDay30(d, isStart){
      let day=d.getDate();
      if(isStart && (day===31 || isEndOfFeb(d))) return 30;
      return Math.min(day,31);
    }
    function calculateMonthsAndDays360(startDate, endDate){
      const s=new Date(startDate), e=new Date(endDate);
      if (isNaN(s) || isNaN(e) || e < s) return {months:0, days:0, totalDays360:0};
      let d1 = adjustDay30(s, true);
      let d2 = adjustDay30(e, false);
      if (d2===31 && (d1===30)) d2 = 30;
      if (d2>30) d2 = 30;
      const monthsBase = (e.getFullYear()-s.getFullYear())*12 + (e.getMonth()-s.getMonth());
      const total = monthsBase*30 + (d2 - d1);
      const months = Math.floor(total/30);
      const days   = total % 30;
      return { months, days, totalDays360: total };
    }

    // ====== A 客編尾碼處理 ======
    let baseAId = ''; // 不含 * 或 ^ 的原始客編
    const aIdInput = document.getElementById('customerA_id');
    const chkDeduct = document.getElementById('chkDeductReferral');
    const chkSpecial = document.getElementById('chkSpecialCase');

    function stripAIdSymbols(s){ return String(s||'').replace(/[*^]+$/g,''); }
    function getAIdSuffix(){
      let suf = '';
      if (chkDeduct.checked) suf += '*';
      if (chkSpecial.checked) suf += '^';
      return suf;
    }
    function applyAIdDecoration(){
      if (!baseAId){ aIdInput.value = ''; return; }
      aIdInput.value = baseAId + getAIdSuffix();
    }
    aIdInput.addEventListener('input', () => { baseAId = stripAIdSymbols(aIdInput.value); });
    aIdInput.addEventListener('blur', applyAIdDecoration);
    chkDeduct.addEventListener('change', applyAIdDecoration);
    chkSpecial.addEventListener('change', applyAIdDecoration);

    // ====== B 客編尾碼處理（新增） ======
    let baseBId = ''; // 不含 * 或 ^ 的原始客編
    const bIdInput = document.getElementById('customerB_id');
    const chkBDeduct = document.getElementById('chkBDeductReferral');
    const chkBSpecial = document.getElementById('chkBSpecialCase');

    function stripBIdSymbols(s){ return String(s||'').replace(/[*^]+$/g,''); }
    function getBIdSuffix(){
      let suf = '';
      if (chkBDeduct.checked) suf += '*';
      if (chkBSpecial.checked) suf += '^';
      return suf;
    }
    function applyBIdDecoration(){
      if (!baseBId){ bIdInput.value = ''; return; }
      bIdInput.value = baseBId + getBIdSuffix();
    }
    bIdInput.addEventListener('input', () => { baseBId = stripBIdSymbols(bIdInput.value); });
    bIdInput.addEventListener('blur', applyBIdDecoration);
    chkBDeduct.addEventListener('change', applyBIdDecoration);
    chkBSpecial.addEventListener('change', applyBIdDecoration);

    // ====== 主要邏輯 ======
// === 30/360 (EU) 計算函式 ===
function calculateMonthsAndDays360(startDate, endDate) {
  const s = new Date(startDate);
  const e = new Date(endDate);

  if (isNaN(s) || isNaN(e) || e < s) {
    return { months: 0, days: 0, totalDays360: 0 };
  }

  let sY = s.getFullYear(), sM = s.getMonth() + 1, sD = s.getDate();
  let eY = e.getFullYear(), eM = e.getMonth() + 1, eD = e.getDate();

  // 歐式 EU 規則：只要是 31 號，就改成 30
  if (sD === 31) sD = 30;
  if (eD === 31) eD = 30;

  // 算總天數（360制）
  const totalDays360 = (eY - sY) * 360 + (eM - sM) * 30 + (eD - sD);

  // 拆成幾個月 + 幾天
  const months = Math.floor(totalDays360 / 30);
  const days = totalDays360 % 30;

  return { months, days, totalDays360 };
}

// === 主要邏輯 ===
function calculateTransferInfo() {
  const transferDate = document.getElementById('transferDate').value;
  const aExp = document.getElementById('customerA_expiry').value;
  const bExp = document.getElementById('customerB_currentExpiry').value;
  if (!transferDate || !aExp || !bExp) return;

  if (new Date(transferDate) >= new Date(aExp)) {
    document.getElementById('transferPeriod').value = '無效的轉移日期';
    ['transferDuration', 'transferDays', 'customerB_newExpiry']
      .forEach(id => document.getElementById(id).value = '');
    return;
  }

  document.getElementById('transferPeriod').value =
    `${formatDateSlash(transferDate)}~${formatDateSlash(aExp)}`;

  const { months, days, totalDays360 } = calculateMonthsAndDays360(transferDate, aExp);

  document.getElementById('transferDuration').value = formatMonthsAndDays(months, days);
  document.getElementById('transferDays').value = totalDays360 + '天';
  document.getElementById('customerB_newExpiry').value =
    formatDate(addMonthsAndDays(new Date(bExp), months, days));
}


    function searchCustomer(type){
      const id=document.getElementById(`customer${type}_id`).value;
      if(!id){alert('請輸入客戶編號');return;}
      const c=customerDatabase[id];
      const status=document.getElementById(`customer${type}Status`);
      if(c){
        if(type==='A'){
          baseAId = stripAIdSymbols(id || c.id || '');
          applyAIdDecoration();
        }else{
          baseBId = stripBIdSymbols(id || c.id || '');
          applyBIdDecoration();
        }
        document.getElementById(`customer${type}_name`).value=c.name;
        document.getElementById(`customer${type}_address`).value=c.address;
        const expId = (type==='A') ? 'customerA_expiry' : 'customerB_currentExpiry';
        document.getElementById(expId).value=c.expiry;
        if(type==='A'){
          document.getElementById('customerA_daysLeft').value = daysBetween(new Date(), c.expiry)+'天';
        }
        status.classList.remove('hidden');
        calculateTransferInfo();
      }else{
        alert('找不到此客戶資料');
        status.classList.add('hidden');
      }
    }

    document.getElementById('searchA').addEventListener('click',()=>searchCustomer('A'));
    document.getElementById('searchB').addEventListener('click',()=>searchCustomer('B'));
    ['transferDate','customerA_expiry','customerB_currentExpiry'].forEach(id=>{
      document.getElementById(id).addEventListener('change',calculateTransferInfo);
    });

    function collectFormData(){
      // 送出前確保兩邊都套用最新尾碼
      baseAId = stripAIdSymbols(aIdInput.value); applyAIdDecoration();
      baseBId = stripBIdSymbols(bIdInput.value); applyBIdDecoration();

      return {
        '申請日期': document.getElementById('applyDate').value || '',
        '客編': document.getElementById('customerA_id').value || '',
        '姓名': document.getElementById('customerA_name').value || '',
        '地址': document.getElementById('customerA_address').value || '',
        '新客編': document.getElementById('customerB_id').value || '',
        '新姓名': document.getElementById('customerB_name').value || '',
        '新地址': document.getElementById('customerB_address').value || '',
        '轉移區間': document.getElementById('transferPeriod').value || '',
        '轉移時間': document.getElementById('transferDuration').value || '',
        '轉移後到期日': document.getElementById('customerB_newExpiry').value || '',
        '經辦人': document.getElementById('handler').value || '',
        '客戶email': document.getElementById('customer_email').value || ''
      };
    }

    function showMessage(message,type='info'){
      const div=document.createElement('div');
      div.textContent=message;
      div.style.cssText=`position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:6px;color:#fff;font-weight:700;z-index:10000;max-width:320px;word-break:break-all;background:${type==='success'?'#16a34a':type==='error'?'#dc2626':'#2563eb'};`;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),3000);
    }

    async function sendData(data){
      try{
        const resp = await fetch(WEB_APP_URL,{
          method:'POST',
          mode:'cors',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data),
          redirect:'follow'
        });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.json();
      }catch(err){
        await fetch(WEB_APP_URL,{
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data)
        });
        return {success:true,message:'已送出（no-cors）'};
      }
    }

    async function handleSubmit(){
      const loading=document.getElementById('loadingOverlay');
      try{
        loading.style.display='flex';
        const form=collectFormData();

        if(!form['客編'] && !form['姓名']){ showMessage('請至少填入 A 客戶的客編或姓名','error'); return; }
        if(!form['經辦人']){ showMessage('請填寫經辦人','error'); return; }

        const res = await sendData(form);
        if(res && res.success){ showMessage('已提交到 Google 試算表並觸發後端流程','success'); }
        else { showMessage('提交失敗：'+(res?.message||'未知錯誤'),'error'); }
      }catch(err){
        showMessage('提交失敗：'+err.message,'error');
      }finally{
        loading.style.display='none';
      }
    }

    document.getElementById('submitToGoogleBtn').addEventListener('click',handleSubmit);

    // 預設日期：今天
    document.getElementById('applyDate').value = formatDate(new Date());
    document.getElementById('transferDate').value = formatDate(new Date());
  </script>
</body>
</html>

















