<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>月份異動申請書</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",Arial;line-height:1.6;padding:20px;max-width:800px;margin:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;margin:10px 0 4px}
    input{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;font-size:16px}
    small.hint{color:#666}
    .err{color:#c62828;display:none}
    button{margin-top:16px;padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;font-size:16px}
    button[disabled]{opacity:.6;cursor:wait}
  </style>
</head>
<body>
  <h2>月份異動申請書</h2>

  <form id="form" onsubmit="sendDataToGoogleAppsScript(event)">
    <div class="row">
      <div>
        <label for="custNo">客編（A）</label>
        <input id="custNo" required />
      </div>
      <div>
        <label for="newCustNo">新客編（B）</label>
        <input id="newCustNo" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="name">姓名（A）</label>
        <input id="name" required />
      </div>
      <div>
        <label for="newName">新姓名（B）</label>
        <input id="newName" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="addr">地址（A）</label>
        <input id="addr" />
      </div>
      <div>
        <label for="newAddr">新地址（B）</label>
        <input id="newAddr" />
      </div>
    </div>

    <!-- 使用期間（自由輸入） -->
    <label for="period">使用期間（自由輸入）</label>
    <input id="period" placeholder="例如：2025/08/01~2025/08/20 或 2025-08-01 ～ 2025/08/20" />
    <small class="hint">貼上即可；會自動解析並計算下列兩欄。</small>
    <div id="periodErr" class="err">時間格式不正確，請用「YYYY/MM/DD ~ YYYY/MM/DD」</div>

    <div class="row">
      <div>
        <label for="months">轉移時間（自動）</label>
        <input id="months" readonly />
      </div>
      <div>
        <label for="expiry">轉移後到期日（自動）</label>
        <input id="expiry" readonly />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="handler">經辦人</label>
        <input id="handler" placeholder="經辦人姓名" />
      </div>
      <div>
        <label for="customerEmail">客戶 email</label>
        <input id="customerEmail" type="email" placeholder="name@example.com" />
      </div>
    </div>

    <!-- 若你的舊頁面還有「電話」欄位，這顆 JS 會自動把它們隱藏；這裡不放電話欄位 -->

    <button id="submitBtn" type="submit">提交</button>
  </form>

  <script>
    // 你的 Web App URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxlt2EHIr4rGPa9IKIOkuWjs-B-IhIMxfSxFLjuVisXcjqUYShu9d3a-QBGnKK18BGi/exec';

    // —— 工具：解析日期與區間 ——
    function parseYMD(s){
      const m = String(s).trim().match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
      if(!m) return null;
      const y = +m[1], mo = +m[2]-1, d = +m[3];
      const dt = new Date(y, mo, d);
      return (dt.getFullYear()===y && dt.getMonth()===mo && dt.getDate()===d) ? dt : null;
    }
    function fmtYMD(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}`; }
    function parsePeriodToDates(periodStr){
      const parts = String(periodStr).replace(/～/g,'~').replace(/至|to/gi,'~').split('~');
      if(parts.length!==2) return null;
      const s = parseYMD(parts[0]); const e = parseYMD(parts[1]);
      if(!s || !e || e < s) return null;
      return {start:s, end:e};
    }
    function calcDays(start, end){ return Math.round((end - start)/86400000) + '日'; }

    // —— 自動隱藏任何「電話」欄位（保留舊框架但不顯示） ——
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('label').forEach(l => {
        if (/電話/.test(l.textContent)) {
          const block = l.closest('.row, .form-row, .form-group, .field, div') || l;
          block.style.display = 'none';
        }
      });
    });

    // —— 當使用期間變更，帶出天數與到期日 ——
    const periodEl = document.getElementById('period');
    ['change','blur','input'].forEach(ev => periodEl.addEventListener(ev, () => {
      const box = parsePeriodToDates(periodEl.value);
      const err = document.getElementById('periodErr');
      if(!box){ err.style.display='block'; document.getElementById('months').value=''; document.getElementById('expiry').value=''; return; }
      err.style.display='none';
      document.getElementById('months').value = calcDays(box.start, box.end);
      document.getElementById('expiry').value = fmtYMD(box.end);
    }));

    // —— 送出：保留你的函式名（全域） ——
    window.sendDataToGoogleAppsScript = async function(e){
      e?.preventDefault?.();

      const box = parsePeriodToDates(periodEl.value);
      if(!box){ document.getElementById('periodErr').style.display='block'; alert('使用期間格式錯誤'); return; }

      const get = id => (document.getElementById(id)?.value || '').trim();
      const payload = {
        '客編': get('custNo'),
        '姓名': get('name'),
        '地址': get('addr'),
        '新客編': get('newCustNo'),
        '新姓名': get('newName'),
        '新地址': get('newAddr'),
        '轉移區間': `${fmtYMD(box.start)}~${fmtYMD(box.end)}`,
        '轉移時間': get('months') || calcDays(box.start, box.end),
        '轉移後到期日': get('expiry') || fmtYMD(box.end),
        '經辦人': get('handler'),
        '客戶email': get('customerEmail')
      };

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = '送出中…';

      try{
        const resp = await fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        let ok = resp.ok, data=null;
        try{ data = await resp.json(); ok = data?.success ?? ok; }catch(_){}
        if(ok) alert('提交成功！'); else throw new Error(data?.message || ('HTTP '+resp.status));
      }catch(err){
        try{
          await fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          alert('提交成功！（no-cors）');
        }catch(e2){ alert('提交失敗：'+e2.message); }
      }finally{
        btn.disabled = false; btn.textContent = '提交';
      }
    };
  </script>
</body>
</html>





