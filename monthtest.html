<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客戶資料轉移系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Noto Sans TC',sans-serif; background:#f0f5ff; margin:0; padding:0; }
    .card { box-shadow:0 4px 15px rgba(0,0,0,.1); transition:all .3s ease; }
    .card:hover { box-shadow:0 8px 25px rgba(0,0,0,.15); }
    .btn-primary{ background:#3b82f6; transition:all .3s; } .btn-primary:hover{ background:#2563eb; }
    .btn-secondary{ background:#6b7280; transition:all .3s; } .btn-secondary:hover{ background:#4b5563; }
    .btn-success{ background:#10b981; transition:all .3s; } .btn-success:hover{ background:#059669; }
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:9999;}
    .loading-spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- 載入指示器 -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p id="loadingText" class="text-lg font-medium text-gray-700">正在處理，請稍候...</p>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-center text-gray-800">客戶資料轉移系統</h1>
      <p class="text-center text-gray-600 mt-2">將A客戶的使用權限轉移給B客戶</p>
    </header>

    <div id="inputForm">
      <!-- ======= 你的原有 UI（略，與你提供的相同） ======= -->
      <!-- 這裡直接貼你原本的兩張卡、轉移設定、三顆按鈕 + 提交至Google試算表按鈕 -->
      <!-- ==== 開始：A/B 客戶卡 & 轉移設定（與你提供的完全相同） ==== -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- A 客戶卡 ...（原樣保留） -->
        <!-- 省略：請把你提供的 A/B 客戶卡原碼貼回來 -->
      </div>

      <div class="card bg-white rounded-lg p-6 mt-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6">轉移設定</h2>
        <!-- 省略：請把你提供的轉移設定原碼貼回來 -->
      </div>

      <div class="flex justify-center mt-8 space-x-4">
        <button id="calculateBtn" class="btn-primary text-white px-6 py-3 rounded-md font-medium">計算轉移資訊</button>
        <button id="transferBtn" class="btn-success text-white px-6 py-3 rounded-md font-medium">確認轉移</button>
        <button id="resetBtn" class="btn-secondary text-white px-6 py-3 rounded-md font-medium">重置表單</button>
        <button id="submitToGoogleBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md font-medium">
          提交至Google試算表
        </button>
      </div>
      <!-- ==== 結束：你的原有區塊 ==== -->

      <!-- ===== 新增：PDF 預覽 + 寄信區 ===== -->
      <div id="pdfSection" class="card bg-white rounded-lg p-6 mt-8 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-800">PDF 預覽</h2>
          <div class="text-sm text-gray-500" id="pdfMeta"></div>
        </div>
        <iframe id="pdfPreview" title="PDF 預覽區" class="w-full h-[75vh] border border-gray-200 rounded-lg"></iframe>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-gray-700 mb-2">收件者 Email</label>
            <input id="mailTo" type="email" class="w-full px-4 py-2 border rounded-md" placeholder="example@domain.com">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">主旨</label>
            <input id="mailSubject" type="text" class="w-full px-4 py-2 border rounded-md" placeholder="客戶轉移單 PDF">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">內文</label>
            <input id="mailBody" type="text" class="w-full px-4 py-2 border rounded-md" placeholder="您好，附件為本次轉移單 PDF，請查收。">
          </div>
        </div>

        <div class="flex items-center gap-3 mt-4">
          <button id="sendEmailBtn" class="btn-primary text-white px-4 py-2 rounded-md">寄出 Email（附 PDF）</button>
          <a id="downloadLink" href="#" target="_blank" rel="noreferrer noopener"
             class="px-4 py-2 rounded-md border border-gray-300 text-blue-600 hidden">下載 PDF</a>
          <span id="pdfStatus" class="text-sm text-gray-500"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== 你的既有 JS：資料庫、工具函式、查詢/計算/重置/收集資料 等（保留原樣） =====
    const customerDatabase = {
      'A001': { name:'王小明', address:'台北市信義區信義路100號', phone:'0912-345-678', expiry:'2025-12-31' },
      'A002': { name:'李小華', address:'台中市西屯區台灣大道200號', phone:'0923-456-789', expiry:'2025-10-15' },
      'B001': { name:'張小美', address:'高雄市前鎮區中山路300號', phone:'0934-567-890', expiry:'2025-08-20' },
      'B002': { name:'陳小強', address:'新北市板橋區文化路400號', phone:'0945-678-901', expiry:'2025-09-10' }
    };

    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdMBdE6J_2zK_M0Id7QyEN1Z4nlrKxZEePyHAdKsHsjagYOzx9QwvzuSIpt6G5UKEhKA/exec';

    function daysBetween(a, b){return Math.round((new Date(b)-new Date(a))/(24*60*60*1000));}
    function addMonthsAndDays(date, months, days){ const r=new Date(date); r.setMonth(r.getMonth()+months); r.setDate(r.getDate()+days); return r; }
    function formatDate(d){ const x=new Date(d), m=String(x.getMonth()+1).padStart(2,'0'), da=String(x.getDate()).padStart(2,'0'); return `${x.getFullYear()}-${m}-${da}`;}
    function formatDateSlash(d){ const x=new Date(d), m=String(x.getMonth()+1).padStart(2,'0'), da=String(x.getDate()).padStart(2,'0'); return `${x.getFullYear()}/${m}/${da}`;}
    function calculateMonthsAndDays(startDate,endDate){
      const s=new Date(startDate), e=new Date(endDate);
      let years=e.getFullYear()-s.getFullYear(), months=e.getMonth()-s.getMonth(), days=e.getDate()-s.getDate();
      if(days<0){ months--; days += new Date(e.getFullYear(), e.getMonth(), 0).getDate(); }
      if(months<0){ years--; months += 12; }
      months += years*12; return {months, days};
    }
    function formatMonthsAndDays(m,d){ return m>0&&d>0?`${m}個月${d}日`:m>0?`${m}個月`:d>0?`${d}日`:'0日'; }

    // 你的查詢/計算/監聽/重置/collectFormData/sendDataToGoogleAppsScript/showMessage ...（照你原本）
    // -- 略，請直接保留你傳來的原碼 --

    // === 額外：顯示/隱藏 Loading ===
    const $loading = document.getElementById('loadingOverlay');
    function showLoading(txt){ document.getElementById('loadingText').textContent = txt || '處理中…'; $loading.style.display='flex';}
    function hideLoading(){ $loading.style.display='none';}

    // === 新增：PDF & Email 串接 ===
    let lastPdf = { fileId:null, previewUrl:null, downloadUrl:null, name:null };

    function buildPdfFileName() {
      const aId = document.getElementById('customerA_id').value || 'A';
      const bId = document.getElementById('customerB_id').value || 'B';
      const when = new Date();
      const y = when.getFullYear(), m = String(when.getMonth()+1).padStart(2,'0'), d = String(when.getDate()).padStart(2,'0');
      return `客戶轉移_${aId}->${bId}_${y}${m}${d}`;
    }

    async function makePdf(docId, fileName) {
      const fileName = buildPdfFileName();
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'make_pdf', docId: DOC_ID_FOR_PREVIEW, fileName })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'make_pdf 失敗');

      lastPdf = data;
      document.getElementById('pdfPreviewBeta').src = data.previewUrl;
      document.getElementById('btnSendEmailBeta').disabled = false;
      const dl = document.getElementById('btnDownloadPdfBeta');
      dl.classList.remove('hidden'); dl.href = data.downloadUrl; dl.textContent = `下載 ${data.name}`;
      document.getElementById('pdfMeta').textContent = data.name;
      document.getElementById('pdfBetaStatus').textContent = 'PDF 已產生（測試）';
    }
  </script>
</body>
</html>























