<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡ˆä»¶å¯©æ ¸ç³»çµ±</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f3f4f6; margin: 0; }
    .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; text-align: center; }
    h2 { color: #1f2937; margin-bottom: 1.5rem; }
    p { color: #4b5563; margin-bottom: 1.5rem; font-size: 1.1rem; }
    input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-sizing: border-box; font-size: 1rem; text-align: center; }
    button { width: 100%; padding: 0.75rem; background-color: #3B82F6; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
    button:hover { opacity: 0.9; }
    button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .hidden { display: none; }
    .verify-theme button { background-color: #10B981; }
    .email-theme button { background-color: #3B82F6; }
    #status { margin-top: 1rem; font-size: 0.9rem; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="card" id="app">
    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div id="loadingView">
      <p>æ­£åœ¨è®€å–æ¡ˆä»¶è³‡è¨Š...</p>
    </div>

    <!-- éŒ¯èª¤ç•«é¢ -->
    <div id="errorView" class="hidden">
      <h2 style="color: #EF4444;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
      <p id="errorMsg">ç„¡æ•ˆçš„é€£çµåƒæ•¸</p>
    </div>

    <!-- ä¸»è¦æ“ä½œç•«é¢ -->
    <div id="mainView" class="hidden">
      <h2 id="pageTitle">ç¢ºèªå‹•ä½œ</h2>
      <p id="instruction">è«‹è¼¸å…¥æ‚¨çš„å§“åï¼š</p>
      
      <input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å" required />
      
      <button id="actionBtn" onclick="submitData()">ç¢ºèªé€å‡º</button>
      
      <div id="status"></div>
    </div>
    
    <!-- å®Œæˆç•«é¢ -->
    <div id="successView" class="hidden">
      <h2 style="color: #10B981;">ğŸ‰ åŸ·è¡ŒæˆåŠŸ</h2>
      <p id="successMsg"></p>
      <button onclick="window.close()" style="background-color: #6B7280;">é—œé–‰è¦–çª—</button>
    </div>
  </div>

  <script>
    // [é‡è¦] è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ (éƒ¨ç½²ç‚º Web App å¾Œçš„ç¶²å€)
    const GAS_API_URL = "https://script.google.com/macros/s/æ‚¨çš„ID/exec";

    // å–å¾— URL åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action'); // verify_page æˆ– email_page
    const row = urlParams.get('row');

    // åˆå§‹åŒ–é é¢
    window.onload = function() {
      const loading = document.getElementById('loadingView');
      const main = document.getElementById('mainView');
      const error = document.getElementById('errorView');
      
      loading.classList.add('hidden');

      if (!action || !row) {
        error.classList.remove('hidden');
        document.getElementById('errorMsg').innerText = "é€£çµç¼ºå°‘å¿…è¦åƒæ•¸ (Action or Row ID)";
        return;
      }

      // æ ¹æ“šå‹•ä½œè¨­å®šä»‹é¢
      const title = document.getElementById('pageTitle');
      const btn = document.getElementById('actionBtn');
      const card = document.querySelector('.card');

      if (action === 'verify_page') {
        title.innerText = "âœ… ç¢ºèªæ ¸å‡†æ¡ˆä»¶";
        btn.innerText = "ç¢ºèªæ ¸å‡†";
        card.classList.add('verify-theme');
        document.getElementById('instruction').innerText = "è«‹è¼¸å…¥å¯©æ ¸äººå§“åï¼š";
      } else if (action === 'email_page') {
        title.innerText = "âœ‰ï¸ ç¢ºèªç™¼é€ Email";
        btn.innerText = "ç¢ºèªç™¼é€";
        card.classList.add('email-theme');
        document.getElementById('instruction').innerText = "è«‹è¼¸å…¥å¯„ä»¶äººå§“åï¼š";
      } else {
        error.classList.remove('hidden');
        return;
      }

      main.classList.remove('hidden');
    };

    function submitData() {
      const user = document.getElementById('username').value.trim();
      if (!user) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }

      const btn = document.getElementById('actionBtn');
      const status = document.getElementById('status');
      
      // é–å®šæŒ‰éˆ•
      btn.disabled = true;
      btn.innerHTML = '<div class="loader"></div> è™•ç†ä¸­...';
      status.innerText = "æ­£åœ¨é€£ç·šè‡³ Google ç³»çµ±...";
      status.style.color = "#666";

      // æº–å‚™è¦å‚³é€çš„è³‡æ–™
      // action è¦è½‰æ›ä¸€ä¸‹: verify_page -> verify, email_page -> email
      const apiAction = action === 'verify_page' ? 'verify' : 'email';
      
      const payload = {
        action: apiAction,
        row: row,
        user: user
      };

      // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚
      // æ³¨æ„ï¼šGAS çš„ Web App å¿…é ˆè¨­å®šç‚º "Execute as Me" å’Œ "Who has access: Anyone"
      fetch(GAS_API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
        // mode: 'no-cors' // åƒè¬ä¸è¦é–‹ no-corsï¼Œå¦å‰‡æ”¶ä¸åˆ°å›å‚³çµæœ
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          document.getElementById('mainView').classList.add('hidden');
          document.getElementById('successView').classList.remove('hidden');
          document.getElementById('successMsg').innerText = data.message;
        } else {
          throw new Error(data.message);
        }
      })
      .catch(err => {
        console.error(err);
        btn.disabled = false;
        btn.innerText = "é‡è©¦";
        status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤: " + err.message;
        status.style.color = "red";
      });
    }
  </script>
</body>
</html>
