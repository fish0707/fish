<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <!-- ç¢ºä¿åœ¨è¡Œå‹•è£ç½®ä¸Šé¡¯ç¤ºæ­£ç¢º -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡ˆä»¶å¯©æ ¸ç³»çµ±</title>
  <!-- å¼•å…¥ Tailwind CSS ç¾åŒ–ä»‹é¢ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
    .card-header { background: linear-gradient(90deg, #1a73e8 0%, #0d47a1 100%); color: white; }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9); z-index: 50;
      display: none; justify-content: center; align-items: center;
      flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8;
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
  </style>
</head>
<body class="p-4 md:p-6 min-h-screen flex items-center justify-center">

<!-- æ ¸å¿ƒå¡ç‰‡å®¹å™¨ -->
<div class="w-full max-w-4xl bg-white shadow-xl rounded-xl overflow-hidden transition-all duration-300" id="mainCard">
  
  <!-- 1. è¡¨å–®å¡«å¯«æ¨¡å¼ (é è¨­é¡¯ç¤º) -->
  <div id="formMode" class="hidden">
    <div class="card-header p-6">
      <h2 class="text-2xl font-bold">ğŸ“„ åˆç´„è³‡æ–™è¼¸å…¥ç³»çµ±</h2>
      <p class="opacity-90 mt-1 text-sm">è«‹å¡«å¯«é›™æ–¹è³‡æ–™ä»¥ç”Ÿæˆ PDF ä¸¦è§¸ç™¼å¯©æ ¸æµç¨‹</p>
    </div>
    
    <form id="contractForm" class="p-6 space-y-6" onsubmit="submitCreateForm(event)">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-100">
        <h3 class="text-lg font-bold text-indigo-800 mb-4 border-b border-indigo-200 pb-2">ğŸ“… åŸºæœ¬è³‡æ–™</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç”³è«‹æ—¥æœŸ</label>
            <input type="date" id="dateInput" name="request_date" required class="w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ¡ˆä»¶é¡å‹</label>
            <select name="service_type" required class="w-full rounded-md border-gray-300 shadow-sm border p-2 bg-white focus:ring-2 focus:ring-indigo-500">
              <option value="" disabled selected>è«‹é¸æ“‡é¡å‹</option>
              <option value="è®Šæ›´ç™»è¨˜äºº">1. è®Šæ›´ç™»è¨˜äºº</option>
              <option value="æ›´å">2. æ›´å</option>
              <option value="ç¹¼æ‰¿æ›´å">3. ç¹¼æ‰¿æ›´å</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å€åŸŸ</label>
            <select name="region" required class="w-full rounded-md border-gray-300 shadow-sm border p-2 bg-white focus:ring-2 focus:ring-indigo-500">
              <option value="" disabled selected>è«‹é¸æ“‡å€åŸŸ</option>
              <option value="åŒ—å€">åŒ—å€ (TP)</option>
              <option value="ä¸­å—å€">ä¸­å—å€ (TC)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ¶ç·¨è™Ÿ</label>
            <input type="text" name="client_id" placeholder="ä¾‹å¦‚: A152689" required class="w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-2 focus:ring-indigo-500">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">åˆ°æœŸæ—¥æœŸ</label>
            <input type="date" name="expiry_date" required class="w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-2 focus:ring-indigo-500">
          </div>
        </div>
      </div>

      <!-- å®¢æˆ¶è³‡æ–™é›™æ¬„ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- åŸç™»è¨˜äºº (A) -->
        <div class="bg-blue-50 p-5 rounded-lg border border-blue-100">
          <h3 class="text-lg font-bold text-blue-800 mb-4 border-b border-blue-200 pb-2">ğŸ‘¤ åŸç™»è¨˜äºº (A)</h3>
          <div class="space-y-3">
            <input type="text" name="clientA_name" placeholder="å§“å" required class="w-full rounded border p-2">
            <!-- [ä¿®æ”¹] æ”¹ç‚º type="text" è§£é™¤æ‰‹æ©Ÿæ ¼å¼é™åˆ¶ -->
            <input type="text" name="clientA_phone" placeholder="é›»è©±" class="w-full rounded border p-2">
            <input type="text" name="clientA_address" placeholder="åœ°å€" required class="w-full rounded border p-2">
            <!-- [ä¿®æ”¹] æ”¹ç‚º type="text" è§£é™¤ Email æ ¼å¼é™åˆ¶ -->
            <input type="text" name="clientA_email" placeholder="Email" class="w-full rounded border p-2">
          </div>
        </div>
        <!-- æ–°ç™»è¨˜äºº (B) -->
        <div class="bg-green-50 p-5 rounded-lg border border-green-100">
          <h3 class="text-lg font-bold text-green-800 mb-4 border-b border-green-200 pb-2">ğŸ‘¤ æ–°ç™»è¨˜äºº (B)</h3>
          <div class="space-y-3">
            <input type="text" name="clientB_name" placeholder="å§“å" required class="w-full rounded border p-2">
            <!-- [ä¿®æ”¹] æ”¹ç‚º type="text" è§£é™¤æ‰‹æ©Ÿæ ¼å¼é™åˆ¶ -->
            <input type="text" name="clientB_phone" placeholder="é›»è©±" class="w-full rounded border p-2">
            <!-- [ä¿®æ”¹] æ”¹ç‚º type="text" è§£é™¤ Email æ ¼å¼é™åˆ¶ -->
            <input type="text" name="clientB_email" placeholder="Email" class="w-full rounded border p-2">
          </div>
        </div>
      </div>

      <!-- ç™¼é€è¨­å®š -->
      <div class="bg-gray-50 p-5 rounded-lg border border-gray-200">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“® ç™¼é€è¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¶“è¾¦äººå§“å</label>
            <input type="text" name="handler" required class="w-full rounded border p-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ¥æ”¶ PDF Email</label>
            <input type="email" name="recipient_email" required class="w-full rounded border p-2">
          </div>
        </div>
      </div>

      <div class="flex justify-end pt-2">
        <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition shadow-lg flex items-center font-bold text-lg w-full md:w-auto justify-center">
          ğŸš€ ç”Ÿæˆä¸¦ç™¼é€
        </button>
      </div>
    </form>
  </div>

  <!-- 2. æ ¸å‡†ç¢ºèªæ¨¡å¼ (ç•¶ç¶²å€å¸¶æœ‰ action åƒæ•¸æ™‚é¡¯ç¤º) -->
  <div id="verifyMode" class="hidden text-center">
    <div class="bg-green-600 p-6 text-white">
      <h2 class="text-2xl font-bold">âœ… ç¢ºèªæ ¸å‡†ä¸¦ç™¼é€ Email</h2>
      <p class="opacity-90 mt-2">è«‹ç¢ºèªæ‚¨è¦åŸ·è¡Œæ­¤æ“ä½œ</p>
    </div>
    
    <div class="p-8 space-y-6">
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 text-left">
        <p class="font-bold text-yellow-800">æ“ä½œèªªæ˜ï¼š</p>
        <p class="text-sm text-yellow-700 mt-1">æ­¤å‹•ä½œå°‡æœƒï¼š<br>1. åœ¨ç³»çµ±ä¸­å°‡æ­¤æ¡ˆä»¶æ¨™è¨˜ç‚ºã€Œå·²æ ¸å‡†ã€ã€‚<br>2. è‡ªå‹•ç™¼é€ PDF é™„ä»¶éƒµä»¶çµ¦å®¢æˆ¶ã€‚</p>
      </div>

      <div>
        <label class="block text-left text-sm font-bold text-gray-700 mb-2">è«‹è¼¸å…¥æ‚¨çš„å§“å (æ“ä½œäººå“¡)</label>
        <input type="text" id="verifyUser" placeholder="ä¾‹å¦‚ï¼šç‹ç¶“ç†" class="w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
      </div>

      <button onclick="submitVerify()" class="w-full bg-green-600 text-white py-4 rounded-lg text-xl font-bold hover:bg-green-700 transition shadow-lg flex justify-center items-center">
        ç¢ºèªç„¡èª¤ï¼Œç«‹å³ç™¼é€
      </button>
    </div>
  </div>

  <!-- 3. æˆåŠŸç•«é¢ -->
  <div id="successMode" class="hidden text-center p-12">
    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
    </div>
    <h2 class="text-3xl font-bold text-gray-800 mb-4">åŸ·è¡ŒæˆåŠŸï¼</h2>
    <p id="successMsg" class="text-gray-600 mb-8 text-lg"></p>
    <button onclick="window.close()" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 font-medium">é—œé–‰è¦–çª—</button>
  </div>

  <!-- 4. éŒ¯èª¤ç•«é¢ -->
  <div id="errorMode" class="hidden text-center p-12">
    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">ç™¼ç”ŸéŒ¯èª¤</h2>
    <p id="errorMsg" class="text-red-600 mb-6"></p>
    <a href="?" class="text-blue-600 underline">è¿”å›é¦–é </a>
  </div>

</div>

<!-- è¼‰å…¥ä¸­å‹•ç•« -->
<div id="loading" class="loading-overlay">
  <div class="spinner mb-4"></div>
  <h3 class="text-xl font-bold text-gray-700">ç³»çµ±è™•ç†ä¸­...</h3>
  <p class="text-gray-500">æ­£åœ¨èˆ‡ Google é›²ç«¯é€šè¨Š</p>
</div>

<script>
  // ==========================================
  // [è¨­å®š] è«‹å¡«å…¥æ‚¨çš„ GAS Web App ç¶²å€
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzJplSHq2GjqPhJBN2qsDOxTRF2W3GmQ21VCly2xqZ2_OahO4knbby2i6OrcIda6kXH/exec";

  // å…¨åŸŸè®Šæ•¸
  const urlParams = new URLSearchParams(window.location.search);
  const actionParam = urlParams.get('action');
  const rowParam = urlParams.get('row');

  // åˆå§‹åŒ–
  window.onload = function() {
    // è¨­å®šæ—¥æœŸé è¨­å€¼
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('dateInput');
    if(dateInput) dateInput.value = today;

    // è·¯ç”±åˆ¤æ–·ï¼šæ ¹æ“šç¶²å€åƒæ•¸æ±ºå®šé¡¯ç¤ºå“ªå€‹ç•«é¢
    if (actionParam === 'verify_and_send_page' && rowParam) {
      showMode('verifyMode');
    } else if (!actionParam) {
      showMode('formMode');
    } else {
      showError("ç„¡æ•ˆçš„é€£çµåƒæ•¸ï¼Œè«‹æª¢æŸ¥ç¶²å€ã€‚");
    }
  };

  // åˆ‡æ›ç•«é¢è¼”åŠ©å‡½å¼
  function showMode(modeId) {
    ['formMode', 'verifyMode', 'successMode', 'errorMode'].forEach(id => {
      document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(modeId).classList.remove('hidden');
  }

  function showError(msg) {
    showMode('errorMode');
    document.getElementById('errorMsg').innerText = msg;
  }

  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
  }

  // === å‹•ä½œ 1: æäº¤æ–°è¡¨å–® ===
  function submitCreateForm(e) {
    e.preventDefault();
    const form = document.getElementById('contractForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // è¨­å®šå¾Œç«¯éœ€è¦çš„ action
    data.action = 'submit_form';

    sendToGAS(data, () => {
      form.reset();
      document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
    });
  }

  // === å‹•ä½œ 2: åŸ·è¡Œæ ¸å‡†ä¸¦ç™¼ä¿¡ ===
  function submitVerify() {
    const user = document.getElementById('verifyUser').value.trim();
    if (!user) { alert("è«‹è¼¸å…¥æ‚¨çš„å§“åï¼"); return; }

    const data = {
      action: 'verify_and_send', // å°æ‡‰ Code.gs çš„ doPost é‚è¼¯
      row: rowParam,
      user: user
    };

    sendToGAS(data);
  }

  // === é€šç”¨: ç™¼é€è³‡æ–™çµ¦ GAS ===
  function sendToGAS(payload, onSuccessCallback) {
    showLoading(true);

    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain;charset=utf-8" }, // é¿å… CORS é æª¢
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(response => {
      showLoading(false);
      if (response.status === 'success') {
        showMode('successMode');
        document.getElementById('successMsg').innerText = response.message;
        if (onSuccessCallback) onSuccessCallback();
      } else {
        showError(response.message || "æœªçŸ¥éŒ¯èª¤");
      }
    })
    .catch(err => {
      showLoading(false);
      showError("é€£ç·šå¤±æ•—ï¼š" + err);
    });
  }
</script>

</body>
</html>
