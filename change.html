<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡ˆä»¶å¯©æ ¸ç³»çµ±</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f3f4f6; margin: 0; }
    .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; text-align: center; }
    h2 { color: #1f2937; margin-bottom: 1.5rem; }
    p { color: #4b5563; margin-bottom: 1.5rem; font-size: 1.1rem; }
    input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-sizing: border-box; font-size: 1rem; text-align: center; }
    button { width: 100%; padding: 0.75rem; background-color: #3B82F6; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
    button:hover { opacity: 0.9; }
    button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .hidden { display: none; }
    .verify-theme button { background-color: #10B981; }
    .email-theme button { background-color: #3B82F6; }
    #status { margin-top: 1rem; font-size: 0.9rem; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .debug-info { margin-top: 20px; font-size: 12px; color: #999; text-align: left; background: #eee; padding: 10px; border-radius: 4px; display: none; word-break: break-all;}
  </style>
</head>
<body>

  <div class="card" id="app">
    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div id="loadingView">
      <p>æ­£åœ¨è®€å–æ¡ˆä»¶è³‡è¨Š...</p>
    </div>

    <!-- éŒ¯èª¤ç•«é¢ -->
    <div id="errorView" class="hidden">
      <h2 style="color: #EF4444;">âš ï¸ é€£çµç„¡æ•ˆ</h2>
      <p id="errorMsg">é€£çµç¼ºå°‘å¿…è¦åƒæ•¸</p>
      <div style="font-size: 0.9rem; color: #666; margin-top: 1rem; text-align: left; background: #fff5f5; padding: 10px; border-radius: 5px;">
        <b>å¦‚ä½•æ¸¬è©¦æ­¤æª”æ¡ˆï¼Ÿ</b><br>
        è«‹ä¸è¦ç›´æ¥é›™æ“Šé–‹å•Ÿï¼Œè«‹åœ¨ç¶²å€åˆ—å¾Œæ–¹åŠ å…¥æ¸¬è©¦åƒæ•¸ï¼š<br>
        <code style="background: #eee; padding: 2px;">?action=verify_page&row=2</code>
      </div>
    </div>

    <!-- ä¸»è¦æ“ä½œç•«é¢ -->
    <div id="mainView" class="hidden">
      <h2 id="pageTitle">ç¢ºèªå‹•ä½œ</h2>
      <p id="instruction">è«‹è¼¸å…¥æ‚¨çš„å§“åï¼š</p>
      
      <input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å" required />
      
      <button id="actionBtn" onclick="submitData()">ç¢ºèªé€å‡º</button>
      
      <div id="status"></div>
      
      <!-- Debug è¨Šæ¯å€ (ç™¼ç”ŸéŒ¯èª¤æ™‚é¡¯ç¤º) -->
      <div id="debugInfo" class="debug-info"></div>
    </div>
    
    <!-- å®Œæˆç•«é¢ -->
    <div id="successView" class="hidden">
      <h2 style="color: #10B981;">ğŸ‰ åŸ·è¡ŒæˆåŠŸ</h2>
      <p id="successMsg"></p>
      <button onclick="window.close()" style="background-color: #6B7280;">é—œé–‰è¦–çª—</button>
    </div>
  </div>

  <script>
    // ==========================================
    // [é‡è¦] è«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆæ‚¨ GAS éƒ¨ç½²å¾Œçš„ Web App URL (ä»¥ /exec çµå°¾)
    // ==========================================
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzJplSHq2GjqPhJBN2qsDOxTRF2W3GmQ21VCly2xqZ2_OahO4knbby2i6OrcIda6kXH/exec";

    // å–å¾— URL åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action'); // verify_page æˆ– email_page
    const row = urlParams.get('row');

    // åˆå§‹åŒ–é é¢
    window.onload = function() {
      const loading = document.getElementById('loadingView');
      const main = document.getElementById('mainView');
      const error = document.getElementById('errorView');
      
      loading.classList.add('hidden');

      if (!action || !row) {
        error.classList.remove('hidden');
        document.getElementById('errorMsg').innerText = "é€£çµç¼ºå°‘å¿…è¦åƒæ•¸ (Action or Row ID)";
        return;
      }

      // æ ¹æ“šå‹•ä½œè¨­å®šä»‹é¢
      const title = document.getElementById('pageTitle');
      const btn = document.getElementById('actionBtn');
      const card = document.querySelector('.card');

      if (action === 'verify_page') {
        title.innerText = "âœ… ç¢ºèªæ ¸å‡†æ¡ˆä»¶";
        btn.innerText = "ç¢ºèªæ ¸å‡†";
        card.classList.add('verify-theme');
        document.getElementById('instruction').innerText = "è«‹è¼¸å…¥å¯©æ ¸äººå§“åï¼š";
      } else if (action === 'email_page') {
        title.innerText = "âœ‰ï¸ ç¢ºèªç™¼é€ Email";
        btn.innerText = "ç¢ºèªç™¼é€";
        card.classList.add('email-theme');
        document.getElementById('instruction').innerText = "è«‹è¼¸å…¥å¯„ä»¶äººå§“åï¼š";
      } else {
        error.classList.remove('hidden');
        return;
      }

      main.classList.remove('hidden');
    };

    function submitData() {
      const user = document.getElementById('username').value.trim();
      if (!user) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }
      
      if (GAS_API_URL.includes("æ‚¨çš„ID")) {
        alert("âš ï¸ éŒ¯èª¤ï¼šæ‚¨å°šæœªåœ¨ external_index.html ä¸­è¨­å®šæ­£ç¢ºçš„ GAS_API_URLï¼");
        return;
      }

      const btn = document.getElementById('actionBtn');
      const status = document.getElementById('status');
      const debugInfo = document.getElementById('debugInfo');
      
      // é–å®šæŒ‰éˆ•
      btn.disabled = true;
      btn.innerHTML = '<div class="loader"></div> è™•ç†ä¸­...';
      status.innerText = "æ­£åœ¨é€£ç·šè‡³ç³»çµ±...";
      status.style.color = "#666";
      debugInfo.style.display = 'none';

      // æº–å‚™è¦å‚³é€çš„è³‡æ–™
      const apiAction = action === 'verify_page' ? 'verify' : 'email';
      
      const payload = {
        action: apiAction,
        row: row,
        user: user
      };

      // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚
      fetch(GAS_API_URL, {
        method: 'POST',
        // [é—œéµä¿®æ­£] ä½¿ç”¨ text/plain ä»¥é¿å… CORS Preflight (OPTIONS) è«‹æ±‚è¢«æ“‹
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          document.getElementById('mainView').classList.add('hidden');
          document.getElementById('successView').classList.remove('hidden');
          document.getElementById('successMsg').innerText = data.message;
        } else {
          throw new Error(data.message || "æœªçŸ¥éŒ¯èª¤");
        }
      })
      .catch(err => {
        console.error(err);
        btn.disabled = false;
        btn.innerText = "é‡è©¦";
        status.innerText = "âŒ ç™¼é€å¤±æ•—";
        status.style.color = "red";
        
        // é¡¯ç¤ºé™¤éŒ¯è¨Šæ¯æ–¹ä¾¿æ‚¨æˆªåœ–
        debugInfo.style.display = 'block';
        debugInfo.innerHTML = `<b>Error Details:</b><br>${err.message}<br><br><b>Target:</b> ${GAS_API_URL}`;
        
        if (err.message.includes("Failed to fetch")) {
           status.innerText += " (CORS æˆ– ç¶²å€éŒ¯èª¤)";
        }
      });
    }
  </script>
</body>
</html>
