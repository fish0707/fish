<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <!-- å¼•å…¥ Tailwind CSS ç¾åŒ–ä»‹é¢ -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
    .card-header { background: linear-gradient(90deg, #1a73e8 0%, #0d47a1 100%); color: white; }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8); z-index: 50;
      display: none; justify-content: center; align-items: center;
      flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8;
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-6">

<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
  <div class="card-header p-6">
    <h2 class="text-2xl font-bold">ğŸ“„ åˆç´„è³‡æ–™è¼¸å…¥ç³»çµ±</h2>
    <p class="opacity-90">è«‹å¡«å¯«é›™æ–¹è³‡æ–™ä»¥ç”Ÿæˆ PDF ä¸¦è§¸ç™¼å¯©æ ¸æµç¨‹</p>
  </div>

  <form id="contractForm" class="p-6 space-y-8" onsubmit="submitForm(event)">
    
    <!-- åŸºæœ¬è³‡æ–™å€å¡Š -->
    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
      <h3 class="text-xl font-bold text-indigo-800 mb-4 border-b border-indigo-200 pb-2">ğŸ“… åŸºæœ¬è³‡æ–™</h3>
      
      <!-- ç¬¬ä¸€è¡Œï¼šç”³è«‹æ—¥æœŸèˆ‡æ¡ˆä»¶é¡å‹ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">ç”³è«‹æ—¥æœŸ</label>
          <input type="date" id="dateInput" name="request_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 p-2 border">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">æ¡ˆä»¶é¡å‹</label>
          <select name="service_type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 p-2 border bg-white">
            <option value="" disabled selected>è«‹é¸æ“‡é¡å‹</option>
            <option value="è®Šæ›´ç™»è¨˜äºº">1. è®Šæ›´ç™»è¨˜äºº</option>
            <option value="æ›´å">2. æ›´å</option>
            <option value="ç¹¼æ‰¿æ›´å">3. ç¹¼æ‰¿æ›´å</option>
          </select>
        </div>
      </div>

      <!-- ç¬¬äºŒè¡Œï¼šå€åŸŸèˆ‡å®¢æˆ¶ç·¨è™Ÿ (æ–°å¢å€åŸŸ) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">å€åŸŸ</label>
          <select name="region" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 p-2 border bg-white">
            <option value="" disabled selected>è«‹é¸æ“‡å€åŸŸ</option>
            <option value="åŒ—å€">åŒ—å€ (TP)</option>
            <option value="ä¸­å—å€">ä¸­å—å€ (TC)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">å®¢æˆ¶ç·¨è™Ÿ</label>
          <!-- æé†’ä½¿ç”¨è€…ç³»çµ±æœƒè‡ªå‹•åŠ å‰ç¶´ -->
          <input type="text" name="client_id" placeholder="ä¾‹å¦‚: A152689 (ç³»çµ±è‡ªå‹•åŠ  TP/TC)" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 p-2 border">
        </div>
      </div>

      <!-- ç¬¬ä¸‰è¡Œï¼šåˆ°æœŸæ—¥æœŸ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <label class="block text-sm font-medium text-gray-700">åˆ°æœŸæ—¥æœŸ</label>
          <input type="date" name="expiry_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 p-2 border">
        </div>
      </div>
    </div>

    <!-- å…©æ¬„ä½ˆå±€ (å®¢æˆ¶è³‡æ–™) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      
      <!-- å®¢æˆ¶ A å€å¡Š -->
      <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
        <h3 class="text-xl font-bold text-blue-800 mb-4 border-b border-blue-200 pb-2">ğŸ‘¤ å®¢æˆ¶ A (åŸç™»è¨˜è€…)</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">å§“å</label>
            <input type="text" name="clientA_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2 border">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">é›»è©±</label>
            <input type="tel" name="clientA_phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2 border">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">åœ°å€</label>
            <input type="text" name="clientA_address" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2 border">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="clientA_email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2 border">
          </div>
        </div>
      </div>

      <!-- å®¢æˆ¶ B å€å¡Š -->
      <div class="bg-green-50 p-4 rounded-lg border border-green-100">
        <h3 class="text-xl font-bold text-green-800 mb-4 border-b border-green-200 pb-2">ğŸ‘¤ å®¢æˆ¶ B (æ–°ç™»è¨˜è€…)</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">å§“å</label>
            <input type="text" name="clientB_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 p-2 border">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">é›»è©±</label>
            <input type="tel" name="clientB_phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 p-2 border">
          </div>
        
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="clientB_email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 p-2 border">
          </div>
        </div>
      </div>
    </div>

    <!-- ç¶“è¾¦èˆ‡ç™¼é€è³‡è¨Š -->
    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“® ç™¼é€è¨­å®š</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <label class="block text-sm font-medium text-gray-700">ç¶“è¾¦äººå§“å</label>
          <input type="text" name="handler" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-500 focus:ring focus:ring-gray-200 p-2 border">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">æœ€çµ‚æ¥æ”¶ PDF çš„ Email</label>
          <input type="email" name="recipient_email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-500 focus:ring focus:ring-gray-200 p-2 border">
        </div>
      </div>
    </div>

    <!-- æŒ‰éˆ•å€ -->
    <div class="flex justify-end pt-4">
      <button type="submit" id="submitBtn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow flex items-center font-bold text-lg">
        ğŸš€ ç”Ÿæˆ PDF ä¸¦ç™¼é€å¯©æ ¸
      </button>
    </div>
  </form>
</div>

<!-- è¼‰å…¥ä¸­å‹•ç•« -->
<div id="loading" class="loading-overlay">
  <div class="spinner mb-4"></div>
  <h3 class="text-xl font-bold text-gray-700">ç³»çµ±è™•ç†ä¸­...</h3>
  <p class="text-gray-500">æ­£åœ¨å¯«å…¥è©¦ç®—è¡¨ã€ç”Ÿæˆ PDF ä¸¦é€šçŸ¥å¯©æ ¸äººå“¡</p>
</div>

<script>
  // [é‡è¦] è«‹å°‡æ­¤ç¶²å€æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€ (çµå°¾æ˜¯ /exec)
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzJplSHq2GjqPhJBN2qsDOxTRF2W3GmQ21VCly2xqZ2_OahO4knbby2i6OrcIda6kXH/exec";

  // é é¢è¼‰å…¥æ™‚ï¼Œè‡ªå‹•è¨­å®šæ—¥æœŸç‚ºä»Šå¤©
  window.onload = function() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0'); 
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;
    
    document.getElementById('dateInput').value = todayStr;
  };

  function submitForm(e) {
    e.preventDefault();
    const form = document.getElementById('contractForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // æ”¶é›†è¡¨å–®è³‡æ–™
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // å¢åŠ ä¸€å€‹ action æ¬„ä½ï¼Œå‘Šè¨´å¾Œç«¯é€™æ˜¯ã€Œæäº¤è¡¨å–®ã€å‹•ä½œ
    data.action = 'submit_form';

    // é¡¯ç¤º Loading
    document.getElementById('loading').style.display = 'flex';
    submitBtn.disabled = true;

    // ä½¿ç”¨ fetch å–ä»£ google.script.run
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: {
        // ä½¿ç”¨ text/plain é¿å… CORS preflight
        "Content-Type": "text/plain;charset=utf-8"
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(response => {
      document.getElementById('loading').style.display = 'none';
      submitBtn.disabled = false;
      
      if (response.status === 'success') {
        alert("âœ… æˆåŠŸï¼\n" + response.message);
        form.reset();
        // é‡è¨­æ—¥æœŸç‚ºä»Šå¤©
        window.onload();
      } else {
        alert("âŒ éŒ¯èª¤ï¼š\n" + (response.message || "æœªçŸ¥éŒ¯èª¤"));
      }
    })
    .catch(error => {
      document.getElementById('loading').style.display = 'none';
      submitBtn.disabled = false;
      alert("âŒ ç³»çµ±é€£ç·šéŒ¯èª¤ï¼š" + error);
      console.error(error);
    });
  }
</script>

</body>
</html>
