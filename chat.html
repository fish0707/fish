<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>客服訓練聊天室（AI 扮演客戶）</title>
<style>
  body{font-family:Arial, sans-serif;background:#f4f4f4;display:flex;justify-content:center;padding:20px}
  .card{width:720px;background:#fff;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.08);overflow:hidden}
  .header{padding:16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .chat-box{height:480px;overflow:auto;padding:20px}
  .message{margin-bottom:12px}
  .trainer{ text-align:right }
  .customer{ text-align:left }
  .trainer p{display:inline-block;background:#0b84ff;color:#fff;padding:10px 14px;border-radius:18px;max-width:70%}
  .customer p{display:inline-block;background:#eee;color:#222;padding:10px 14px;border-radius:18px;max-width:70%}
  .input-row{display:flex;padding:12px;border-top:1px solid #eee}
  input[type="text"]{flex:1;padding:10px;border-radius:20px;border:1px solid #ddd;margin-right:10px}
  button{background:#0b84ff;color:#fff;padding:8px 14px;border:none;border-radius:18px;cursor:pointer}
  .scenario{font-size:14px;color:#333}
</style>
</head>
<body>

<div class="card">
  <div class="header">
    <div>
      <strong>客服訓練（AI = 客戶）</strong><br>
      <span class="scenario" id="scenarioLabel">尚未開始</span>
    </div>
    <div>
      <button id="startBtn">開始考試</button>
    </div>
  </div>

  <div class="chat-box" id="chatBox"></div>

  <div class="input-row">
    <input type="text" id="userInput" placeholder="輸入你的回覆（你扮演客服）..." />
    <button id="sendBtn">發送</button>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz2ijZszQ8fVKNzCTAJU5TMGU3Urv0iMfa3yTrBJauNhdvx_GhQZa66aNy7cmLwbEtC-A/exec"; // <- 換成你的 GAS /exec URL
let scenarioIndex = null;
let scenarioText = "";
// conversation 以陣列保存，元素格式：{ sender: "trainer"|"customer", text: "..." }
let conversation = [];

const chatBox = document.getElementById("chatBox");
const scenarioLabel = document.getElementById("scenarioLabel");

function addBubble(sender, text) {
  const div = document.createElement("div");
  div.className = "message " + (sender === "trainer" ? "trainer": "customer");
  const p = document.createElement("p");
  p.textContent = text;
  div.appendChild(p);
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function startTest() {
  // 清除舊對話
  conversation = [];
  chatBox.innerHTML = "";
  scenarioLabel.textContent = "抽題中...";
  try {
    const res = await fetch(GAS_URL + "?action=start");
    const data = await res.json();
    if (!data || !data.ok) {
      scenarioLabel.textContent = "抽題失敗";
      return;
    }
    scenarioIndex = data.scenarioIndex;
    scenarioText = data.scenario;
    scenarioLabel.textContent = `情境 ${scenarioIndex}：` + (scenarioText.length > 80 ? scenarioText.slice(0,80) + "..." : scenarioText);

    // 顯示情境（可視化）
    addBubble("customer", "【系統情境】 " + scenarioText);

    // 顯示初始客戶開場
    const initial = data.initialCustomer || "您好，我想請問關於網路的事...";
    conversation.push({ sender: "customer", text: initial });
    addBubble("customer", initial);

  } catch (err) {
    scenarioLabel.textContent = "抽題錯誤";
    console.error(err);
  }
}

document.getElementById("startBtn").addEventListener("click", startTest);

document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("userInput").addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  conversation.push({ sender: "trainer", text });
  addBubble("trainer", text);
  input.value = "";

  addBubble("customer", "正在思考中...");

  try {
    const formData = new FormData();
    formData.append("conversation", JSON.stringify(conversation));
    formData.append("scenarioIndex", scenarioIndex);

    const res = await fetch(GAS_URL, {
      method: "POST",
      body: formData
    });
    const data = await res.json();

    // 移除「正在思考中...」
    chatBox.lastChild.remove();

    const reply = data.reply || "（無回覆）";
    conversation.push({ sender: "customer", text: reply });
    addBubble("customer", reply);

  } catch (err) {
    chatBox.lastChild.remove();
    addBubble("customer", "❌ 出錯了：" + err.message);
  }
}

</script>

</body>
</html>




