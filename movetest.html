<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客戶資料查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- 頂部導航 -->
    <nav class="bg-white shadow-lg border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-blue-600">客戶服務系統</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">客服專員：張小美</span>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 查詢區域 -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">客戶資料查詢</h2>
                <p class="text-gray-600">請輸入客戶資訊進行查詢</p>
            </div>

            <div class="max-w-2xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">客戶編號</label>
                        <input type="text" id="customer-id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                               placeholder="例：C001234">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">客戶姓名</label>
                        <input type="text" id="customer-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                               placeholder="例：王小明">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">聯絡電話</label>
                        <input type="text" id="customer-phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                               placeholder="例：02-2345-6789">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">身分證字號</label>
                        <input type="text" id="customer-id-number" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                               placeholder="例：A123456789">
                    </div>
                </div>

                <div class="text-center">
                    <button onclick="searchCustomer()" class="bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        查詢客戶資料
                    </button>
                </div>
            </div>
        </div>

        <!-- 查詢結果區域 -->
        <div id="search-results" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-6">
                    <h3 class="text-2xl font-bold text-white">客戶資料</h3>
                </div>

                <div class="p-8">
                    <!-- 基本資料 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                基本資料
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">客戶編號：</span>
                                    <span class="font-medium" id="result-customer-id">C001234</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">客戶姓名：</span>
                                    <span class="font-medium" id="result-customer-name">王小明</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">身分證字號：</span>
                                    <span class="font-medium" id="result-id-number">A123456789</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">聯絡電話：</span>
                                    <span class="font-medium" id="result-phone">02-2345-6789</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">手機號碼：</span>
                                    <span class="font-medium" id="result-mobile">0912-345-678</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                服務地址
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">地區：</span>
                                    <span class="font-medium" id="result-area">台北市信義區</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">社區名稱：</span>
                                    <span class="font-medium" id="result-community">信義花園</span>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-gray-600">完整地址：</span>
                                    <div class="mt-1 font-medium" id="result-address">台北市信義區信義路五段7號12樓</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 移機申請區域 -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            移機申請
                        </h4>

                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">備註說明</label>
                            <textarea id="move-notes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" 
                                      placeholder="請詳細說明移機需求、新地址資訊或其他特殊要求..."></textarea>
                        </div>

                        <div class="text-center">
                            <button onclick="submitMoveRequest()" class="bg-orange-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-orange-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                                提交移機申請
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 無查詢結果 -->
        <div id="no-results" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="text-gray-400 mb-4">
                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.044-5.709-2.709M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">查無客戶資料</h3>
                <p class="text-gray-600 mb-4">請確認輸入的資訊是否正確，或聯絡系統管理員</p>
                <button onclick="clearSearch()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                    重新查詢
                </button>
            </div>
        </div>
    </div>

    <!-- 成功提交模態框 -->
    <div id="success-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6 text-center">
                    <div class="text-green-600 mb-4">
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">申請提交成功！</h3>
                    <p class="text-gray-600 mb-4">移機申請已成功提交，系統已為您建立客訴單號：<span id="generated-ticket-id" class="font-semibold text-blue-600"></span></p>
                    <p class="text-sm text-gray-500 mb-6">申請將轉入後台處理系統，相關人員會盡快與您聯絡</p>
                    
                    <div class="space-y-3">
                        <button id="backend-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            進入後台處理系統
                        </button>
                        <button onclick="closeSuccessModal()" class="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                            關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 後台處理系統 -->
    <div id="backend-system" class="hidden">
        <!-- 後台導航 -->
        <nav class="bg-gray-800 shadow-lg border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <h1 class="text-2xl font-bold text-white">後台處理系統</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-300">處理專員：李大華</span>
                        <button onclick="goToFrontend()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                            返回客戶系統
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 後台主要內容 -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 標籤頁導航 -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button id="tab-pending" onclick="switchTab('pending')" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            代處理 <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full ml-2">2</span>
                        </button>
                        <button id="tab-processing" onclick="switchTab('processing')" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            處理中 <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full ml-2">0</span>
                        </button>
                        <button id="tab-approval" onclick="switchTab('approval')" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            主管簽核 <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full ml-2">0</span>
                        </button>
                        <button id="tab-completed" onclick="switchTab('completed')" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            已完成 <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full ml-2">0</span>
                        </button>
                    </nav>
                </div>

                <!-- 代處理內容 -->
                <div id="pending-content" class="p-6">
                    <div class="space-y-4">
                        <!-- 示例工單 1 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4 mb-2">
                                        <span class="text-lg font-semibold text-gray-900">客訴單號: CS-2024-001</span>
                                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">緊急</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                        <div><span class="font-medium">客戶編號:</span> C001234</div>
                                        <div><span class="font-medium">社區名稱:</span> 信義花園</div>
                                        <div><span class="font-medium">地區:</span> 台北市信義區</div>
                                        <div><span class="font-medium">建立時間:</span> 2024-01-15 14:30</div>
                                    </div>
                                    <div class="text-sm text-gray-700 bg-gray-50 p-3 rounded">
                                        <strong>客訴內容:</strong> 需要辦理移機服務，搬遷至新地址，請安排相關作業。
                                    </div>
                                </div>
                                <button onclick="startProcessing('CS-2024-001')" class="ml-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">
                                    開始處理
                                </button>
                            </div>
                        </div>

                        <!-- 示例工單 2 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4 mb-2">
                                        <span class="text-lg font-semibold text-gray-900">客訴單號: CS-2024-002</span>
                                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">一般</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                        <div><span class="font-medium">客戶編號:</span> C001235</div>
                                        <div><span class="font-medium">社區名稱:</span> 大安御品</div>
                                        <div><span class="font-medium">地區:</span> 台北市大安區</div>
                                        <div><span class="font-medium">建立時間:</span> 2024-01-15 16:45</div>
                                    </div>
                                    <div class="text-sm text-gray-700 bg-gray-50 p-3 rounded">
                                        <strong>客訴內容:</strong> 需要辦理移機服務，搬遷至新地址，請安排相關作業。
                                    </div>
                                </div>
                                <button onclick="startProcessing('CS-2024-002')" class="ml-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">
                                    開始處理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 處理中內容 -->
                <div id="processing-content" class="p-6 hidden">
                    <div class="space-y-4" id="processing-list">
                        <!-- 處理中的工單會動態加入這裡 -->
                    </div>
                    <div id="processing-empty" class="text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">目前沒有處理中的工單</h3>
                        <p class="text-gray-500">處理中的工單會顯示在這裡</p>
                    </div>
                </div>

                <!-- 主管簽核內容 -->
                <div id="approval-content" class="p-6 hidden">
                    <div class="space-y-4" id="approval-list">
                        <!-- 等待主管簽核的工單會動態加入這裡 -->
                    </div>
                    <div id="approval-empty" class="text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">目前沒有等待簽核的工單</h3>
                        <p class="text-gray-500">等待主管簽核的工單會顯示在這裡</p>
                    </div>
                </div>

                <!-- 已完成內容 -->
                <div id="completed-content" class="p-6 hidden">
                    <div class="space-y-4" id="completed-list">
                        <!-- 已完成的工單會動態加入這裡 -->
                    </div>
                    <div id="completed-empty" class="text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">目前沒有已完成的工單</h3>
                        <p class="text-gray-500">已完成的工單會顯示在這裡</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 退回理由模態框 -->
        <div id="rejection-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-900">退回工單</h3>
                            <button onclick="closeRejectionModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">工單編號：<span id="rejection-work-order-number" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600">請說明退回理由：</p>
                        </div>

                        <div class="mb-6">
                            <textarea id="rejection-reason" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 resize-none" 
                                      placeholder="請詳細說明退回原因，例如：地址資訊不完整、安裝日期需要調整、缺少必要文件等..."></textarea>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button onclick="closeRejectionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                取消
                            </button>
                            <button onclick="confirmRejection()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                確認退回
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 工單修正模態框 -->
        <div id="reprocess-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-screen overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-900">修正工單</h3>
                            <button onclick="closeReprocessModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- 工單基本資訊 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">工單資訊</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="font-medium">工單編號:</span> <span id="reprocess-work-order-number">-</span></div>
                                <div><span class="font-medium">客戶編號:</span> <span id="reprocess-customer-id">-</span></div>
                                <div><span class="font-medium">客戶姓名:</span> <span id="reprocess-customer-name">-</span></div>
                                <div><span class="font-medium">新地址:</span> <span id="reprocess-address">-</span></div>
                                <div><span class="font-medium">新社區:</span> <span id="reprocess-community">-</span></div>
                                <div><span class="font-medium">聯絡時間:</span> <span id="reprocess-contact-time">-</span></div>
                                <div><span class="font-medium">原址暫停:</span> <span id="reprocess-suspend-original">-</span></div>
                                <div><span class="font-medium">轉移日期確認:</span> <span id="reprocess-transfer-confirmed">-</span></div>
                                <div class="col-span-2"><span class="font-medium">原備註:</span> <span id="reprocess-original-notes">-</span></div>
                            </div>
                        </div>

                        <!-- 退回理由顯示 -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-red-900 mb-2 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                主管退回理由
                            </h4>
                            <p class="text-red-800" id="reprocess-rejection-reason">-</p>
                        </div>

                        <!-- 修正資料區域 -->
                        <div id="reprocess-data-section">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <h4 class="font-semibold text-blue-900 mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    修正資料
                                </h4>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">安裝日期 *</label>
                                        <input type="date" id="reprocess-install-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">修正說明 *</label>
                                        <textarea id="reprocess-correction-notes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" 
                                                  placeholder="請詳細說明針對主管退回理由所做的修正內容..." required></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end mt-6">
                                    <button onclick="confirmReprocessData()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 font-medium">
                                        確認資料無誤
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 確認送出區域 -->
                        <div id="reprocess-confirm-section" class="hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                <h4 class="font-semibold text-green-900 mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    確認修正內容
                                </h4>
                                
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-700">修正後安裝日期:</span>
                                        <span id="confirm-install-date" class="text-gray-900">-</span>
                                    </div>
                                    <div>
                                        <span class="font-medium text-gray-700">修正說明:</span>
                                        <div id="confirm-correction-notes" class="mt-1 p-2 bg-white rounded border text-gray-900">-</div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between mt-6">
                                    <button onclick="backToReprocessData()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                                        返回修改
                                    </button>
                                    <button onclick="submitReprocessedWorkOrder()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 font-medium">
                                        送出修正工單
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 工單建立模態框 -->
        <div id="work-order-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-900">建立工單</h3>
                            <button onclick="closeWorkOrderModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- 客戶資訊顯示 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">客戶資訊</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="font-medium">客訴單號:</span> <span id="modal-ticket-id">-</span></div>
                                <div><span class="font-medium">客戶編號:</span> <span id="modal-customer-id">-</span></div>
                                <div><span class="font-medium">客戶姓名:</span> <span id="modal-customer-name">-</span></div>
                                <div><span class="font-medium">地區:</span> <span id="modal-area">-</span></div>
                                <div><span class="font-medium">社區:</span> <span id="modal-community">-</span></div>
                                <div><span class="font-medium">電話:</span> <span id="modal-phone">-</span></div>
                                <div><span class="font-medium">手機:</span> <span id="modal-mobile">-</span></div>
                                <div class="col-span-2"><span class="font-medium">地址:</span> <span id="modal-address">-</span></div>
                                <div class="col-span-2"><span class="font-medium">客訴內容:</span> <span id="modal-complaint-content">-</span></div>
                            </div>
                        </div>

                        <!-- 工單表單 -->
                        <form class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">新地址 *</label>
                                    <input type="text" id="new-address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">新社區 *</label>
                                    <input type="text" id="new-community" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">預約安裝日期 *</label>
                                    <input type="date" id="install-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">聯絡時間</label>
                                    <select id="contact-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="上午">上午 (09:00-12:00)</option>
                                        <option value="下午">下午 (13:00-17:00)</option>
                                        <option value="晚上">晚上 (18:00-21:00)</option>
                                        <option value="全天">全天 (09:00-21:00)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 勾選選項 -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="text-sm font-medium text-gray-900 mb-3">移機相關設定</h5>
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="suspend-original" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label for="suspend-original" class="ml-2 text-sm text-gray-700">原址需要暫停服務</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="transfer-date-confirmed" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label for="transfer-date-confirmed" class="ml-2 text-sm text-gray-700">新址預計轉移日期已確認</label>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                                <textarea id="work-order-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="其他特殊需求或注意事項..."></textarea>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeWorkOrderModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    取消
                                </button>
                                <button type="button" onclick="submitWorkOrder()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    建立工單
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模擬客戶資料庫
        const customerDatabase = {
            'C001234': {
                customerId: 'C001234',
                customerName: '王小明',
                idNumber: 'A123456789',
                phone: '02-2345-6789',
                mobile: '0912-345-678',
                area: '台北市信義區',
                community: '信義花園',
                address: '台北市信義區信義路五段7號12樓',
                services: ['網路服務', '有線電視', '固網電話']
            },
            'C001235': {
                customerId: 'C001235',
                customerName: '李小華',
                idNumber: 'B987654321',
                phone: '02-2876-5432',
                mobile: '0923-456-789',
                area: '台北市大安區',
                community: '大安御品',
                address: '台北市大安區復興南路一段390號8樓',
                services: ['網路服務', '有線電視', 'MOD服務']
            },
            'C001236': {
                customerId: 'C001236',
                customerName: '張美玲',
                idNumber: 'C456789123',
                phone: '02-2234-5678',
                mobile: '0934-567-890',
                area: '台北市松山區',
                community: '松山新城',
                address: '台北市松山區民生東路四段133號5樓',
                services: ['網路服務', '固網電話']
            }
        };

        // 查詢客戶資料
        function searchCustomer() {
            const customerId = document.getElementById('customer-id').value.trim();
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const customerIdNumber = document.getElementById('customer-id-number').value.trim();

            console.log('開始查詢，輸入的資料：', {
                customerId: customerId,
                customerName: customerName,
                customerPhone: customerPhone,
                customerIdNumber: customerIdNumber
            });

            // 檢查是否至少輸入一個查詢條件
            if (!customerId && !customerName && !customerPhone && !customerIdNumber) {
                alert('請至少輸入一個查詢條件');
                return;
            }

            // 模擬查詢過程
            showLoading();

            setTimeout(() => {
                let foundCustomer = null;

                console.log('資料庫內容：', customerDatabase);

                // 根據不同條件查詢
                for (let id in customerDatabase) {
                    const customer = customerDatabase[id];
                    console.log('檢查客戶：', customer);
                    
                    // 客戶編號查詢（完全匹配）
                    if (customerId && customer.customerId === customerId) {
                        console.log('找到匹配的客戶編號：', customer);
                        foundCustomer = customer;
                        break;
                    }
                    
                    // 客戶姓名查詢（部分匹配）
                    if (customerName && customer.customerName.includes(customerName)) {
                        console.log('找到匹配的客戶姓名：', customer);
                        foundCustomer = customer;
                        break;
                    }
                    
                    // 電話查詢（部分匹配）
                    if (customerPhone && customer.phone.includes(customerPhone)) {
                        console.log('找到匹配的電話：', customer);
                        foundCustomer = customer;
                        break;
                    }
                    
                    // 身分證字號查詢（完全匹配）
                    if (customerIdNumber && customer.idNumber === customerIdNumber) {
                        console.log('找到匹配的身分證字號：', customer);
                        foundCustomer = customer;
                        break;
                    }
                }

                console.log('查詢結果：', foundCustomer);

                hideLoading();

                if (foundCustomer) {
                    displayCustomerData(foundCustomer);
                } else {
                    showNoResults();
                }
            }, 1000);
        }

        // 顯示載入狀態
        function showLoading() {
            const button = document.querySelector('button[onclick="searchCustomer()"]');
            button.innerHTML = `
                <svg class="animate-spin w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                查詢中...
            `;
            button.disabled = true;
        }

        // 隱藏載入狀態
        function hideLoading() {
            const button = document.querySelector('button[onclick="searchCustomer()"]');
            button.innerHTML = `
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                查詢客戶資料
            `;
            button.disabled = false;
        }

        // 顯示客戶資料
        function displayCustomerData(customer) {
            // 填入客戶資料
            document.getElementById('result-customer-id').textContent = customer.customerId;
            document.getElementById('result-customer-name').textContent = customer.customerName;
            document.getElementById('result-id-number').textContent = customer.idNumber;
            document.getElementById('result-phone').textContent = customer.phone;
            document.getElementById('result-mobile').textContent = customer.mobile;
            document.getElementById('result-area').textContent = customer.area;
            document.getElementById('result-community').textContent = customer.community;
            document.getElementById('result-address').textContent = customer.address;

            // 儲存當前客戶資料到全域變數
            window.currentCustomer = customer;

            // 顯示結果區域
            document.getElementById('search-results').classList.remove('hidden');
            document.getElementById('no-results').classList.add('hidden');

            // 滾動到結果區域
            document.getElementById('search-results').scrollIntoView({ behavior: 'smooth' });
        }

        // 顯示無結果
        function showNoResults() {
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('no-results').classList.remove('hidden');
            document.getElementById('no-results').scrollIntoView({ behavior: 'smooth' });
        }

        // 清除搜尋
        function clearSearch() {
            document.getElementById('customer-id').value = '';
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('customer-id-number').value = '';
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('no-results').classList.add('hidden');
        }

        // 提交移機申請
        function submitMoveRequest() {
            const moveNotes = document.getElementById('move-notes').value.trim();

            // 驗證必填欄位
            if (!moveNotes) {
                showNotification('請填寫備註說明', 'warning');
                return;
            }

            // 生成客訴單號
            const ticketId = 'CS-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6);

            // 儲存申請資料到 localStorage（模擬傳送到後台）
            const applicationData = {
                ticketId: ticketId,
                customer: window.currentCustomer,
                notes: moveNotes,
                submitTime: new Date().toISOString(),
                status: 'pending'
            };

            localStorage.setItem('moveApplication_' + ticketId, JSON.stringify(applicationData));

            // 顯示成功模態框
            document.getElementById('generated-ticket-id').textContent = ticketId;
            document.getElementById('success-modal').classList.remove('hidden');
        }

        // 關閉成功模態框
        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
            
            // 清除表單
            document.getElementById('move-notes').value = '';
            clearSearch();
        }

        // 進入後台處理系統
        function goToBackend() {
            console.log('進入後台系統');
            
            // 將新申請資料儲存到 localStorage 供後台系統讀取
            const ticketId = document.getElementById('generated-ticket-id').textContent;
            const applicationData = JSON.parse(localStorage.getItem('moveApplication_' + ticketId));
            
            if (applicationData) {
                // 將資料加入到待處理列表
                let pendingApplications = JSON.parse(localStorage.getItem('pendingApplications') || '[]');
                pendingApplications.push(applicationData);
                localStorage.setItem('pendingApplications', JSON.stringify(pendingApplications));
                
                // 觸發後台系統更新事件
                localStorage.setItem('newApplicationAdded', Date.now().toString());
            }
            
            // 切換到後台系統
            const frontendSystem = document.querySelector('.max-w-6xl');
            const backendSystem = document.getElementById('backend-system');
            
            if (frontendSystem) frontendSystem.style.display = 'none';
            if (backendSystem) backendSystem.classList.remove('hidden');
            
            // 載入後台資料
            loadBackendData();
            
            closeSuccessModal();
        }

        // 返回前台系統
        function goToFrontend() {
            console.log('返回前台系統');
            
            const frontendSystem = document.querySelector('.max-w-6xl');
            const backendSystem = document.getElementById('backend-system');
            
            if (backendSystem) backendSystem.classList.add('hidden');
            if (frontendSystem) frontendSystem.style.display = 'block';
        }

        // 載入後台資料
        function loadBackendData() {
            const pendingApplications = JSON.parse(localStorage.getItem('pendingApplications') || '[]');
            const pendingContent = document.getElementById('pending-content');
            const spaceDiv = pendingContent.querySelector('.space-y-4');
            
            // 清空現有的新申請（保留示例工單）
            const existingTickets = spaceDiv.querySelectorAll('[data-new-application]');
            existingTickets.forEach(ticket => ticket.remove());
            
            // 加入新申請
            pendingApplications.forEach(app => {
                const priority = Math.random() > 0.5 ? '緊急' : '一般';
                const priorityClass = priority === '緊急' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                
                const ticketHtml = `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-new-application="true">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4 mb-2">
                                    <span class="text-lg font-semibold text-gray-900">客訴單號: ${app.ticketId}</span>
                                    <span class="${priorityClass} px-2 py-1 rounded-full text-xs font-medium">${priority}</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                    <div><span class="font-medium">客戶編號:</span> ${app.customer.customerId}</div>
                                    <div><span class="font-medium">社區名稱:</span> ${app.customer.community}</div>
                                    <div><span class="font-medium">地區:</span> ${app.customer.area}</div>
                                    <div><span class="font-medium">建立時間:</span> ${new Date(app.submitTime).toLocaleString('zh-TW')}</div>
                                </div>
                                <div class="text-sm text-gray-700 bg-gray-50 p-3 rounded">
                                    <strong>客訴內容:</strong> ${app.notes}
                                </div>
                            </div>
                            <button onclick="startProcessing('${app.ticketId}')" class="ml-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">
                                開始處理
                            </button>
                        </div>
                    </div>
                `;
                
                spaceDiv.insertAdjacentHTML('afterbegin', ticketHtml);
            });
            
            // 更新待處理數量
            updateTabCount('pending', pendingApplications.length);
        }

        // 切換標籤頁
        function switchTab(tabName) {
            // 隱藏所有內容
            document.getElementById('pending-content').classList.add('hidden');
            document.getElementById('processing-content').classList.add('hidden');
            document.getElementById('approval-content').classList.add('hidden');
            document.getElementById('completed-content').classList.add('hidden');
            
            // 移除所有標籤的活動狀態
            document.getElementById('tab-pending').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            document.getElementById('tab-processing').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            document.getElementById('tab-approval').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            document.getElementById('tab-completed').className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            
            // 顯示選中的內容和標籤
            document.getElementById(tabName + '-content').classList.remove('hidden');
            document.getElementById('tab-' + tabName).className = 'py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600';
        }

        // 更新標籤數量
        function updateTabCount(tabName, additionalCount = 0) {
            const tab = document.getElementById('tab-' + tabName);
            const span = tab.querySelector('span');
            const currentCount = parseInt(span.textContent);
            span.textContent = currentCount + additionalCount;
        }

        // 開始處理工單
        function startProcessing(ticketId) {
            // 檢查是否為新申請的工單
            let data = null;
            const pendingApplications = JSON.parse(localStorage.getItem('pendingApplications') || '[]');
            const newApp = pendingApplications.find(app => app.ticketId === ticketId);
            
            if (newApp) {
                data = {
                    customerId: newApp.customer.customerId,
                    customerName: newApp.customer.customerName,
                    area: newApp.customer.area,
                    community: newApp.customer.community,
                    phone: newApp.customer.phone,
                    mobile: newApp.customer.mobile,
                    address: newApp.customer.address,
                    complaint: newApp.notes
                };
            } else {
                // 如果不是新申請，使用示例資料
                const customerData = {
                    'CS-2024-001': {
                        customerId: 'C001234',
                        customerName: '王小明',
                        area: '台北市信義區',
                        community: '信義花園',
                        phone: '02-2345-6789',
                        mobile: '0912-345-678',
                        address: '台北市信義區信義路五段7號',
                        complaint: '需要辦理移機服務，搬遷至新地址，請安排相關作業。'
                    },
                    'CS-2024-002': {
                        customerId: 'C001235',
                        customerName: '李小華',
                        area: '台北市大安區',
                        community: '大安御品',
                        phone: '02-2876-5432',
                        mobile: '0923-456-789',
                        address: '台北市大安區復興南路一段390號',
                        complaint: '需要辦理移機服務，搬遷至新地址，請安排相關作業。'
                    }
                };
                data = customerData[ticketId];
            }

            if (data) {
                document.getElementById('modal-ticket-id').textContent = ticketId;
                document.getElementById('modal-customer-id').textContent = data.customerId;
                document.getElementById('modal-customer-name').textContent = data.customerName;
                document.getElementById('modal-area').textContent = data.area;
                document.getElementById('modal-community').textContent = data.community;
                document.getElementById('modal-phone').textContent = data.phone;
                document.getElementById('modal-mobile').textContent = data.mobile;
                document.getElementById('modal-address').textContent = data.address;
                document.getElementById('modal-complaint-content').textContent = data.complaint;
            }

            // 直接開啟工單建立視窗
            document.getElementById('work-order-modal').classList.remove('hidden');
            
            // 設定預設安裝日期為明天
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('install-date').value = tomorrow.toISOString().split('T')[0];
            
            // 儲存當前處理的工單ID
            window.currentProcessingTicketId = ticketId;
        }

        // 關閉工單建立模態框
        function closeWorkOrderModal() {
            document.getElementById('work-order-modal').classList.add('hidden');
            
            // 清空表單
            document.getElementById('new-address').value = '';
            document.getElementById('new-community').value = '';
            document.getElementById('install-date').value = '';
            document.getElementById('contact-time').value = '上午';
            document.getElementById('work-order-notes').value = '';
            document.getElementById('suspend-original').checked = false;
            document.getElementById('transfer-date-confirmed').checked = false;
        }

        // 提交工單
        function submitWorkOrder() {
            console.log('submitWorkOrder 函數被調用');
            
            const newAddress = document.getElementById('new-address').value.trim();
            const newCommunity = document.getElementById('new-community').value.trim();
            const installDate = document.getElementById('install-date').value;
            const contactTime = document.getElementById('contact-time').value;
            const notes = document.getElementById('work-order-notes').value.trim();
            const suspendOriginal = document.getElementById('suspend-original').checked;
            const transferDateConfirmed = document.getElementById('transfer-date-confirmed').checked;
            
            console.log('表單資料:', {
                newAddress, newCommunity, installDate, contactTime, notes, 
                suspendOriginal, transferDateConfirmed
            });
            
            if (!newAddress || !newCommunity || !installDate) {
                showNotification('請填寫所有必填欄位（新地址、新社區、預約安裝日期）', 'warning');
                return;
            }
            
            // 生成工單號碼
            const workOrderNumber = 'WO-' + new Date().getTime();
            console.log('生成工單號碼:', workOrderNumber);
            
            // 儲存工單資訊
            const workOrder = {
                number: workOrderNumber,
                address: newAddress,
                community: newCommunity,
                installDate: installDate,
                contactTime: contactTime,
                notes: notes,
                suspendOriginal: suspendOriginal,
                transferDateConfirmed: transferDateConfirmed,
                status: 'processing',
                ticketId: window.currentProcessingTicketId,
                customerName: document.getElementById('modal-customer-name').textContent,
                customerId: document.getElementById('modal-customer-id').textContent,
                createTime: new Date().toISOString()
            };
            
            console.log('工單資訊:', workOrder);
            
            // 關閉工單建立視窗
            closeWorkOrderModal();
            
            // 將工單加入主管簽核列表
            addToApprovalList(workOrder);
            
            // 從待處理中移除該工單
            removeFromPendingList(window.currentProcessingTicketId);
            
            // 顯示成功訊息
            setTimeout(() => {
                showNotification(`工單建立成功！\n\n工單編號：${workOrderNumber}\n新地址：${newAddress}\n新社區：${newCommunity}\n安裝日期：${installDate}\n原址暫停：${suspendOriginal ? '是' : '否'}\n轉移日期確認：${transferDateConfirmed ? '是' : '否'}\n\n工單已送至主管簽核。`, 'success');
                
                // 自動切換到主管簽核頁籤
                switchTab('approval');
            }, 100);
        }

        // 將工單加入主管簽核列表
        function addToApprovalList(workOrder) {
            const approvalList = document.getElementById('approval-list');
            const approvalEmpty = document.getElementById('approval-empty');
            
            // 隱藏空狀態提示
            approvalEmpty.style.display = 'none';
            
            const suspendText = workOrder.suspendOriginal ? '是' : '否';
            const transferText = workOrder.transferDateConfirmed ? '是' : '否';
            
            const workOrderHtml = `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-work-order="${workOrder.number}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-2">
                                <span class="text-lg font-semibold text-gray-900">工單編號: ${workOrder.number}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium">等待主管簽核</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                <div><span class="font-medium">客戶編號:</span> ${workOrder.customerId}</div>
                                <div><span class="font-medium">客戶姓名:</span> ${workOrder.customerName}</div>
                                <div><span class="font-medium">新地址:</span> ${workOrder.address}</div>
                                <div><span class="font-medium">新社區:</span> ${workOrder.community}</div>
                                <div><span class="font-medium">安裝日期:</span> ${workOrder.installDate}</div>
                                <div><span class="font-medium">聯絡時間:</span> ${workOrder.contactTime}</div>
                                <div><span class="font-medium">原址暫停:</span> ${suspendText}</div>
                                <div><span class="font-medium">轉移日期確認:</span> ${transferText}</div>
                            </div>
                            <div class="text-sm text-gray-700">
                                <strong>處理項目:</strong> 移機服務安裝
                            </div>
                            ${workOrder.notes ? `<div class="text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded"><strong>備註:</strong> ${workOrder.notes}</div>` : ''}
                        </div>
                        <div class="ml-4 flex flex-col space-y-2">
                            <button onclick="approveWorkOrder('${workOrder.number}')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm font-medium">
                                ✓ 核准
                            </button>
                            <button onclick="showRejectionModal('${workOrder.number}')" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm font-medium">
                                ✗ 退回
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            approvalList.insertAdjacentHTML('beforeend', workOrderHtml);
            
            // 更新主管簽核數量
            updateTabCount('approval', 1);
        }
        
        // 將重新送審的工單加入主管簽核列表
        function addToApprovalListAsResubmit(workOrder) {
            const approvalList = document.getElementById('approval-list');
            const approvalEmpty = document.getElementById('approval-empty');
            
            // 隱藏空狀態提示
            approvalEmpty.style.display = 'none';
            
            const suspendText = workOrder.suspendOriginal ? '是' : '否';
            const transferText = workOrder.transferDateConfirmed ? '是' : '否';
            
            const workOrderHtml = `
                <div class="border border-blue-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-blue-50" data-work-order="${workOrder.number}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-2">
                                <span class="text-lg font-semibold text-gray-900">工單編號: ${workOrder.number}</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">重新送審</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                <div><span class="font-medium">客戶編號:</span> ${workOrder.customerId}</div>
                                <div><span class="font-medium">客戶姓名:</span> ${workOrder.customerName}</div>
                                <div><span class="font-medium">新地址:</span> ${workOrder.address}</div>
                                <div><span class="font-medium">新社區:</span> ${workOrder.community}</div>
                                <div><span class="font-medium">安裝日期:</span> ${workOrder.installDate}</div>
                                <div><span class="font-medium">聯絡時間:</span> ${workOrder.contactTime}</div>
                                <div><span class="font-medium">原址暫停:</span> ${suspendText}</div>
                                <div><span class="font-medium">轉移日期確認:</span> ${transferText}</div>
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>處理項目:</strong> 移機服務安裝
                            </div>
                            ${workOrder.previousRejectionReason ? `<div class="text-sm text-gray-600 mb-2 bg-gray-100 p-2 rounded border-l-4 border-gray-400"><strong>前次退回理由:</strong> ${workOrder.previousRejectionReason}</div>` : ''}
                            <div class="text-sm text-blue-700 bg-blue-100 p-3 rounded border border-blue-200">
                                <strong>修正說明:</strong> ${workOrder.correctionNotes}
                            </div>
                            <div class="text-xs text-gray-500 mt-2">
                                重新送審時間：${new Date(workOrder.resubmitTime).toLocaleString('zh-TW')}
                            </div>
                            ${workOrder.notes ? `<div class="text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded"><strong>原備註:</strong> ${workOrder.notes}</div>` : ''}
                        </div>
                        <div class="ml-4 flex flex-col space-y-2">
                            <button onclick="approveWorkOrder('${workOrder.number}')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm font-medium">
                                ✓ 核准
                            </button>
                            <button onclick="showRejectionModal('${workOrder.number}')" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm font-medium">
                                ✗ 退回
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            approvalList.insertAdjacentHTML('beforeend', workOrderHtml);
            
            // 更新主管簽核數量
            updateTabCount('approval', 1);
        }

        // 將工單加入處理中列表
        function addToProcessingList(workOrder) {
            const processingList = document.getElementById('processing-list');
            const processingEmpty = document.getElementById('processing-empty');
            
            // 隱藏空狀態提示
            processingEmpty.style.display = 'none';
            
            const suspendText = workOrder.suspendOriginal ? '是' : '否';
            const transferText = workOrder.transferDateConfirmed ? '是' : '否';
            
            const workOrderHtml = `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-work-order="${workOrder.number}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-2">
                                <span class="text-lg font-semibold text-gray-900">工單編號: ${workOrder.number}</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">主管已簽核</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                <div><span class="font-medium">客戶編號:</span> ${workOrder.customerId}</div>
                                <div><span class="font-medium">客戶姓名:</span> ${workOrder.customerName}</div>
                                <div><span class="font-medium">新地址:</span> ${workOrder.address}</div>
                                <div><span class="font-medium">新社區:</span> ${workOrder.community}</div>
                                <div><span class="font-medium">安裝日期:</span> ${workOrder.installDate}</div>
                                <div><span class="font-medium">聯絡時間:</span> ${workOrder.contactTime}</div>
                                <div><span class="font-medium">原址暫停:</span> ${suspendText}</div>
                                <div><span class="font-medium">轉移日期確認:</span> ${transferText}</div>
                            </div>
                            <div class="text-sm text-gray-700">
                                <strong>處理項目:</strong> 移機服務安裝
                            </div>
                            ${workOrder.notes ? `<div class="text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded"><strong>備註:</strong> ${workOrder.notes}</div>` : ''}
                        </div>
                        <div class="ml-4 text-sm text-blue-600 font-medium">
                            <div class="text-blue-600 font-medium">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                主管已簽核
                            </div>
                            <div class="text-xs text-gray-500 mt-1">等待安裝單位處理...</div>
                        </div>
                    </div>
                </div>
            `;
            
            processingList.insertAdjacentHTML('beforeend', workOrderHtml);
            
            // 更新處理中數量
            updateTabCount('processing', 1);
        }

        // 從待處理列表移除工單
        function removeFromPendingList(ticketId) {
            // 從 localStorage 移除
            let pendingApplications = JSON.parse(localStorage.getItem('pendingApplications') || '[]');
            pendingApplications = pendingApplications.filter(app => app.ticketId !== ticketId);
            localStorage.setItem('pendingApplications', JSON.stringify(pendingApplications));
            
            // 從 DOM 移除
            const pendingContent = document.getElementById('pending-content');
            const ticketElements = pendingContent.querySelectorAll('[data-new-application]');
            ticketElements.forEach(element => {
                if (element.textContent.includes(ticketId)) {
                    element.remove();
                }
            });
            
            // 更新待處理數量
            const tab = document.getElementById('tab-pending');
            const span = tab.querySelector('span');
            const currentCount = parseInt(span.textContent);
            if (currentCount > 0) {
                span.textContent = currentCount - 1;
            }
        }

        // 主管核准工單
        function approveWorkOrder(workOrderNumber) {
            // 從主管簽核列表移除
            const approvalElement = document.querySelector(`#approval-list [data-work-order="${workOrderNumber}"]`);
            if (approvalElement) {
                approvalElement.remove();
                
                // 檢查是否需要顯示空狀態
                const approvalList = document.getElementById('approval-list');
                const approvalEmpty = document.getElementById('approval-empty');
                if (approvalList.children.length === 0) {
                    approvalEmpty.style.display = 'block';
                }
                
                // 更新主管簽核數量
                const approvalTab = document.getElementById('tab-approval');
                const approvalSpan = approvalTab.querySelector('span');
                const approvalCount = parseInt(approvalSpan.textContent);
                if (approvalCount > 0) {
                    approvalSpan.textContent = approvalCount - 1;
                }
                
                // 取得工單資料並加入處理中列表
                const workOrderData = {
                    number: workOrderNumber,
                    customerId: 'C001234', // 這裡應該從實際資料取得
                    customerName: '王小明', // 這裡應該從實際資料取得
                    address: '新地址', // 這裡應該從實際資料取得
                    community: '新社區', // 這裡應該從實際資料取得
                    installDate: '2024-01-16', // 這裡應該從實際資料取得
                    contactTime: '上午', // 這裡應該從實際資料取得
                    suspendOriginal: false, // 這裡應該從實際資料取得
                    transferDateConfirmed: true, // 這裡應該從實際資料取得
                    notes: '' // 這裡應該從實際資料取得
                };
                
                addToProcessingList(workOrderData);
                
                showNotification(`✅ 工單 ${workOrderNumber} 已核准！\n\n工單已移至「處理中」狀態\n將轉送安裝單位進行後續處理`, 'success');
                
                // 自動切換到處理中頁籤
                switchTab('processing');
                
                // 繼續模擬安裝流程
                simulateExternalProcessing(workOrderNumber);
            }
        }

        // 顯示退回理由模態框
        function showRejectionModal(workOrderNumber) {
            document.getElementById('rejection-work-order-number').textContent = workOrderNumber;
            document.getElementById('rejection-reason').value = '';
            document.getElementById('rejection-modal').classList.remove('hidden');
            window.currentRejectionWorkOrder = workOrderNumber;
        }

        // 關閉退回理由模態框
        function closeRejectionModal() {
            document.getElementById('rejection-modal').classList.add('hidden');
            document.getElementById('rejection-reason').value = '';
            window.currentRejectionWorkOrder = null;
        }

        // 確認退回工單
        function confirmRejection() {
            const reason = document.getElementById('rejection-reason').value.trim();
            const workOrderNumber = window.currentRejectionWorkOrder;
            
            console.log('確認退回 - 理由:', reason);
            console.log('確認退回 - 工單編號:', workOrderNumber);
            
            if (!reason) {
                showNotification('請填寫退回理由', 'warning');
                return;
            }
            
            if (!workOrderNumber) {
                showNotification('系統錯誤：找不到工單編號', 'error');
                return;
            }
            
            // 從主管簽核列表移除
            const approvalElement = document.querySelector(`#approval-list [data-work-order="${workOrderNumber}"]`);
            console.log('找到的簽核元素:', approvalElement);
            
            if (approvalElement) {
                // 直接從HTML內容中提取資料
                const htmlContent = approvalElement.innerHTML;
                console.log('HTML內容:', htmlContent);
                
                // 使用更簡單的方式提取資料
                const workOrderData = {
                    number: workOrderNumber,
                    customerId: extractDataFromHTML(htmlContent, '客戶編號:') || 'C001234',
                    customerName: extractDataFromHTML(htmlContent, '客戶姓名:') || '王小明',
                    address: extractDataFromHTML(htmlContent, '新地址:') || '新地址',
                    community: extractDataFromHTML(htmlContent, '新社區:') || '新社區',
                    installDate: extractDataFromHTML(htmlContent, '安裝日期:') || '2024-01-16',
                    contactTime: extractDataFromHTML(htmlContent, '聯絡時間:') || '上午',
                    suspendOriginal: extractDataFromHTML(htmlContent, '原址暫停:') === '是',
                    transferDateConfirmed: extractDataFromHTML(htmlContent, '轉移日期確認:') === '是',
                    notes: extractDataFromHTML(htmlContent, '備註:') || '',
                    rejectionReason: reason,
                    rejectionTime: new Date().toISOString(),
                    status: 'rejected'
                };
                
                console.log('提取的工單資料:', workOrderData);
                
                // 移除簽核列表中的工單
                approvalElement.remove();
                
                // 檢查是否需要顯示空狀態
                const approvalList = document.getElementById('approval-list');
                const approvalEmpty = document.getElementById('approval-empty');
                if (approvalList.children.length === 0) {
                    approvalEmpty.style.display = 'block';
                }
                
                // 更新主管簽核數量
                const approvalTab = document.getElementById('tab-approval');
                const approvalSpan = approvalTab.querySelector('span');
                const approvalCount = parseInt(approvalSpan.textContent);
                if (approvalCount > 0) {
                    approvalSpan.textContent = approvalCount - 1;
                }
                
                // 將工單加回處理中列表（顯示為退回狀態）
                addToProcessingListAsRejected(workOrderData);
                
                showNotification(`❌ 工單 ${workOrderNumber} 已退回！\n\n退回理由：${reason}\n\n工單已退回至「處理中」狀態\n處理人員需要重新檢視並修正`, 'warning');
                
                // 關閉模態框
                closeRejectionModal();
                
                // 切換到處理中頁籤
                switchTab('processing');
            } else {
                showNotification('系統錯誤：找不到對應的工單', 'error');
            }
        }
        
        // 輔助函數：從HTML內容中提取資料
        function extractDataFromHTML(htmlContent, label) {
            // 移除HTML標籤，只保留文字內容
            const textContent = htmlContent.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ');
            console.log('處理後的文字內容:', textContent);
            
            // 尋找標籤後的內容
            const regex = new RegExp(label + '\\s*([^\\n\\r]+?)(?=\\s*[\\w\\u4e00-\\u9fff]+:|$)', 'i');
            const match = textContent.match(regex);
            const result = match ? match[1].trim() : '';
            console.log(`提取 ${label}:`, result);
            return result;
        }
        
        // 輔助函數：從元素中提取冒號後的文字
        function extractTextAfterColon(element, label) {
            const text = element.textContent || element.innerText;
            const regex = new RegExp(label + '\\s*([^\\n\\r]+)', 'i');
            const match = text.match(regex);
            return match ? match[1].trim() : '';
        }
        
        // 輔助函數：從元素中提取備註
        function extractNotesFromElement(element) {
            const notesElement = element.querySelector('div:contains("備註:")');
            if (notesElement) {
                const text = notesElement.textContent || notesElement.innerText;
                const match = text.match(/備註:\s*(.+)/);
                return match ? match[1].trim() : '';
            }
            return '';
        }

        // 從工單元素中提取資料
        function extractWorkOrderData(element) {
            const workOrderNumber = element.querySelector('[data-work-order]').getAttribute('data-work-order');
            const textContent = element.textContent;
            
            // 簡化的資料提取（實際應用中應該有更完整的資料結構）
            return {
                number: workOrderNumber,
                customerId: 'C001234', // 從實際元素中提取
                customerName: '王小明', // 從實際元素中提取
                address: '新地址', // 從實際元素中提取
                community: '新社區', // 從實際元素中提取
                installDate: '2024-01-16', // 從實際元素中提取
                contactTime: '上午', // 從實際元素中提取
                suspendOriginal: false,
                transferDateConfirmed: true,
                notes: '',
                status: 'rejected'
            };
        }

        // 將退回的工單加入處理中列表
        function addToProcessingListAsRejected(workOrder) {
            const processingList = document.getElementById('processing-list');
            const processingEmpty = document.getElementById('processing-empty');
            
            // 隱藏空狀態提示
            processingEmpty.style.display = 'none';
            
            const suspendText = workOrder.suspendOriginal ? '是' : '否';
            const transferText = workOrder.transferDateConfirmed ? '是' : '否';
            
            const workOrderHtml = `
                <div class="border border-red-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-red-50" data-work-order="${workOrder.number}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-2">
                                <span class="text-lg font-semibold text-gray-900">工單編號: ${workOrder.number}</span>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">主管退回</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                <div><span class="font-medium">客戶編號:</span> ${workOrder.customerId}</div>
                                <div><span class="font-medium">客戶姓名:</span> ${workOrder.customerName}</div>
                                <div><span class="font-medium">新地址:</span> ${workOrder.address}</div>
                                <div><span class="font-medium">新社區:</span> ${workOrder.community}</div>
                                <div><span class="font-medium">安裝日期:</span> ${workOrder.installDate}</div>
                                <div><span class="font-medium">聯絡時間:</span> ${workOrder.contactTime}</div>
                                <div><span class="font-medium">原址暫停:</span> ${suspendText}</div>
                                <div><span class="font-medium">轉移日期確認:</span> ${transferText}</div>
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                <strong>處理項目:</strong> 移機服務安裝
                            </div>
                            <div class="text-sm text-red-700 bg-red-100 p-3 rounded border border-red-200">
                                <strong>退回理由:</strong> ${workOrder.rejectionReason}
                            </div>
                            <div class="text-xs text-gray-500 mt-2">
                                退回時間：${new Date(workOrder.rejectionTime).toLocaleString('zh-TW')}
                            </div>
                            ${workOrder.notes ? `<div class="text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded"><strong>原備註:</strong> ${workOrder.notes}</div>` : ''}
                        </div>
                        <div class="ml-4 flex flex-col space-y-2">
                            <button onclick="reprocessWorkOrder('${workOrder.number}')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">
                                重新處理
                            </button>
                            <div class="text-sm text-red-600 font-medium text-center">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                需要修正
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            processingList.insertAdjacentHTML('afterbegin', workOrderHtml);
            
            // 更新處理中數量
            updateTabCount('processing', 1);
        }

        // 重新處理工單
        function reprocessWorkOrder(workOrderNumber) {
            // 從處理中的工單元素取得原始資料
            const processingElement = document.querySelector(`#processing-list [data-work-order="${workOrderNumber}"]`);
            if (!processingElement) {
                showNotification('找不到對應的工單', 'error');
                return;
            }
            
            // 提取工單資料
            const htmlContent = processingElement.innerHTML;
            const workOrderData = {
                number: workOrderNumber,
                customerId: extractDataFromHTML(htmlContent, '客戶編號:') || 'C001234',
                customerName: extractDataFromHTML(htmlContent, '客戶姓名:') || '王小明',
                address: extractDataFromHTML(htmlContent, '新地址:') || '新地址',
                community: extractDataFromHTML(htmlContent, '新社區:') || '新社區',
                installDate: extractDataFromHTML(htmlContent, '安裝日期:') || '2024-01-16',
                contactTime: extractDataFromHTML(htmlContent, '聯絡時間:') || '上午',
                suspendOriginal: extractDataFromHTML(htmlContent, '原址暫停:') === '是',
                transferDateConfirmed: extractDataFromHTML(htmlContent, '轉移日期確認:') === '是',
                notes: extractDataFromHTML(htmlContent, '原備註:') || '',
                rejectionReason: extractDataFromHTML(htmlContent, '退回理由:') || ''
            };
            
            // 開啟修正工單模態框
            openReprocessModal(workOrderData);
        }
        
        // 開啟修正工單模態框
        function openReprocessModal(workOrderData) {
            // 填入工單資料到修正模態框
            document.getElementById('reprocess-work-order-number').textContent = workOrderData.number;
            document.getElementById('reprocess-customer-id').textContent = workOrderData.customerId;
            document.getElementById('reprocess-customer-name').textContent = workOrderData.customerName;
            document.getElementById('reprocess-address').textContent = workOrderData.address;
            document.getElementById('reprocess-community').textContent = workOrderData.community;
            document.getElementById('reprocess-contact-time').textContent = workOrderData.contactTime;
            document.getElementById('reprocess-suspend-original').textContent = workOrderData.suspendOriginal ? '是' : '否';
            document.getElementById('reprocess-transfer-confirmed').textContent = workOrderData.transferDateConfirmed ? '是' : '否';
            document.getElementById('reprocess-original-notes').textContent = workOrderData.notes || '無';
            document.getElementById('reprocess-rejection-reason').textContent = workOrderData.rejectionReason;
            
            // 設定可修改的欄位
            document.getElementById('reprocess-install-date').value = workOrderData.installDate;
            document.getElementById('reprocess-correction-notes').value = '';
            
            // 儲存工單資料供後續使用
            window.currentReprocessWorkOrder = workOrderData;
            
            // 顯示模態框
            document.getElementById('reprocess-modal').classList.remove('hidden');
        }
        
        // 關閉修正工單模態框
        function closeReprocessModal() {
            document.getElementById('reprocess-modal').classList.add('hidden');
            document.getElementById('reprocess-correction-notes').value = '';
            window.currentReprocessWorkOrder = null;
        }
        
        // 確認資料無誤
        function confirmReprocessData() {
            const installDate = document.getElementById('reprocess-install-date').value;
            const correctionNotes = document.getElementById('reprocess-correction-notes').value.trim();
            
            if (!installDate) {
                showNotification('請選擇安裝日期', 'warning');
                return;
            }
            
            if (!correctionNotes) {
                showNotification('請填寫修正說明', 'warning');
                return;
            }
            
            // 更新工單資料
            window.currentReprocessWorkOrder.installDate = installDate;
            window.currentReprocessWorkOrder.correctionNotes = correctionNotes;
            
            // 顯示確認按鈕
            document.getElementById('reprocess-confirm-section').classList.remove('hidden');
            document.getElementById('reprocess-data-section').classList.add('hidden');
            
            // 顯示確認資料
            document.getElementById('confirm-install-date').textContent = installDate;
            document.getElementById('confirm-correction-notes').textContent = correctionNotes;
        }
        
        // 返回修改資料
        function backToReprocessData() {
            document.getElementById('reprocess-confirm-section').classList.add('hidden');
            document.getElementById('reprocess-data-section').classList.remove('hidden');
        }
        
        // 送出修正後的工單
        function submitReprocessedWorkOrder() {
            const workOrderData = window.currentReprocessWorkOrder;
            
            if (!workOrderData) {
                showNotification('系統錯誤：找不到工單資料', 'error');
                return;
            }
            
            // 從處理中移除原工單
            const processingElement = document.querySelector(`#processing-list [data-work-order="${workOrderData.number}"]`);
            if (processingElement) {
                processingElement.remove();
                
                // 檢查是否需要顯示空狀態
                const processingList = document.getElementById('processing-list');
                const processingEmpty = document.getElementById('processing-empty');
                if (processingList.children.length === 0) {
                    processingEmpty.style.display = 'block';
                }
                
                // 更新處理中數量
                const processingTab = document.getElementById('tab-processing');
                const processingSpan = processingTab.querySelector('span');
                const processingCount = parseInt(processingSpan.textContent);
                if (processingCount > 0) {
                    processingSpan.textContent = processingCount - 1;
                }
            }
            
            // 準備重新送審的工單資料
            const resubmitWorkOrder = {
                number: workOrderData.number,
                customerId: workOrderData.customerId,
                customerName: workOrderData.customerName,
                address: workOrderData.address,
                community: workOrderData.community,
                installDate: workOrderData.installDate,
                contactTime: workOrderData.contactTime,
                suspendOriginal: workOrderData.suspendOriginal,
                transferDateConfirmed: workOrderData.transferDateConfirmed,
                notes: workOrderData.notes,
                correctionNotes: workOrderData.correctionNotes,
                previousRejectionReason: workOrderData.rejectionReason,
                resubmitTime: new Date().toISOString()
            };
            
            // 重新加入主管簽核列表
            addToApprovalListAsResubmit(resubmitWorkOrder);
            
            // 關閉模態框
            closeReprocessModal();
            
            showNotification(`✅ 工單 ${workOrderData.number} 修正完成！\n\n📅 新安裝日期：${workOrderData.installDate}\n📝 修正說明：${workOrderData.correctionNotes}\n\n已重新送交主管簽核`, 'success');
            
            // 切換到主管簽核頁籤
            switchTab('approval');
        }

        // 模擬其他單位處理工單
        function simulateExternalProcessing(workOrderNumber) {
            setTimeout(() => {
                // 更新工單狀態為處理中
                const statusElement = document.getElementById(`status-${workOrderNumber}`);
                const actionElement = document.getElementById(`action-${workOrderNumber}`);
                
                if (statusElement && actionElement) {
                    statusElement.textContent = '安裝中';
                    statusElement.className = 'bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium';
                    actionElement.innerHTML = `
                        <div class="text-orange-600 font-medium">
                            <svg class="w-4 h-4 inline-block mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            安裝進行中
                        </div>
                        <div class="text-xs text-gray-500 mt-1">安裝人員已到現場...</div>
                    `;
                    
                    showNotification(`🔧 工單 ${workOrderNumber} 開始安裝！\n\n👷 安裝人員已派遣\n📍 正在前往客戶新址\n⏱️ 預計安裝時間：2-3小時`, 'info');
                    
                    // 再過一段時間完成安裝
                    setTimeout(() => {
                        // 將工單從處理中移至已完成
                        const processingElement = document.querySelector(`[data-work-order="${workOrderNumber}"]`);
                        if (processingElement) {
                            // 移除處理中的工單
                            processingElement.remove();
                            
                            // 檢查是否需要顯示空狀態
                            const processingList = document.getElementById('processing-list');
                            const processingEmpty = document.getElementById('processing-empty');
                            if (processingList.children.length === 0) {
                                processingEmpty.style.display = 'block';
                            }
                            
                            // 更新處理中數量
                            const processingTab = document.getElementById('tab-processing');
                            const processingSpan = processingTab.querySelector('span');
                            const processingCount = parseInt(processingSpan.textContent);
                            if (processingCount > 0) {
                                processingSpan.textContent = processingCount - 1;
                            }
                            
                            // 加入已完成列表
                            addToCompletedList(workOrderNumber);
                            
                            showNotification(`🎉 工單 ${workOrderNumber} 安裝完成！\n\n✅ 移機服務已完成\n📶 網路服務正常運作\n📞 客戶已確認服務正常\n\n感謝您的耐心等候！`, 'success');
                        }
                    }, 8000); // 8秒後完成安裝
                }
            }, 3000); // 3秒後開始安裝
        }

        // 將工單加入已完成列表
        function addToCompletedList(workOrderNumber) {
            const completedList = document.getElementById('completed-list');
            const completedEmpty = document.getElementById('completed-empty');
            
            // 隱藏空狀態提示
            completedEmpty.style.display = 'none';
            
            const completedHtml = `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-2">
                                <span class="text-lg font-semibold text-gray-900">工單編號: ${workOrderNumber}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">已完成</span>
                            </div>
                            <div class="text-sm text-gray-700 mb-3">
                                <strong>處理項目:</strong> 移機服務安裝 - 已完成安裝
                            </div>
                            <div class="text-sm text-gray-600">
                                <strong>完成時間:</strong> ${new Date().toLocaleString('zh-TW')}
                            </div>
                        </div>
                        <div class="ml-4 text-sm text-green-600 font-medium">
                            ✓ 安裝完成
                        </div>
                    </div>
                </div>
            `;
            
            completedList.insertAdjacentHTML('beforeend', completedHtml);
            
            // 更新已完成數量
            updateTabCount('completed', 1);
        }

        // 通知系統
        function showNotification(message, type = 'info') {
            // 移除現有通知
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // 設定通知樣式
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = '✓';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = '⚠';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = '✗';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    icon = 'ℹ';
            }
            
            // 建立通知元素
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 ${bgColor} ${textColor} px-6 py-4 rounded-lg shadow-lg z-50 max-w-md`;
            notification.style.whiteSpace = 'pre-line';
            notification.innerHTML = `
                <div class="flex items-start">
                    <span class="text-xl mr-3">${icon}</span>
                    <div class="flex-1">
                        <div class="font-medium">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            // 加入到頁面
            document.body.appendChild(notification);
            
            // 自動移除通知
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // 頁面載入時的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 可以在這裡加入初始化邏輯
            console.log('客戶查詢系統已載入');
            
            // 綁定後台按鈕事件
            const backendBtn = document.getElementById('backend-btn');
            if (backendBtn) {
                backendBtn.addEventListener('click', goToBackend);
            }
        });

        // Enter 鍵搜尋功能
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement.id === 'customer-id' || 
                    activeElement.id === 'customer-name' || 
                    activeElement.id === 'customer-phone' || 
                    activeElement.id === 'customer-id-number') {
                    searchCustomer();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a4f1058161f220',t:'MTc1NDM4MjcyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>







