<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會辦退費申請表單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45 );display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8">
    <!-- 載入指示器 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p id="loadingText" class="text-lg font-medium text-gray-700">正在處理，請稍候...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4">
        <!-- 標題區域 -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">會辦退費申請表單</h1>
            <p class="text-gray-600 text-center">請填寫完整資訊以處理您的退費申請</p>
        </div>

        <!-- 主表單 -->
        <form id="refundForm" class="bg-white rounded-lg shadow-lg p-8 space-y-8">
            <!-- 基本資訊區塊 -->
            <div class="border-l-4 border-blue-500 pl-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">基本資訊</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="fillDate" class="block text-sm font-medium text-gray-700 mb-2">填寫日期</label>
                        <input type="date" id="fillDate" name="填寫日期" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div class="lg:col-span-2">
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">會辦主旨</label>
                        <input type="text" id="subject" name="會辦主旨" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入會辦主旨">
                    </div>
                    <div>
                        <label for="paymentMethod" class="block text-sm font-medium text-gray-700 mb-2">繳費方式</label>
                        <select id="paymentMethod" name="繳費方式" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">請選擇繳費方式</option>
                            <option value="信用卡">信用卡</option>
                            <option value="轉帳">轉帳</option>
                            <option value="現金">現金</option>
                            <option value="支票">支票</option>
                        </select>
                    </div>
                    <div>
                        <label for="region" class="block text-sm font-medium text-gray-700 mb-2">區域</label>
                        <input type="text" id="region" name="區域" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入區域">
                    </div>
                    <div>
                        <label for="communityName" class="block text-sm font-medium text-gray-700 mb-2">社區名稱</label>
                        <input type="text" id="communityName" name="社區名稱" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入社區名稱">
                    </div>
                </div>
            </div>

            <!-- 客戶資訊區塊 -->
            <div class="border-l-4 border-green-500 pl-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">客戶資訊</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="customerNumber" class="block text-sm font-medium text-gray-700 mb-2">客戶編號</label>
                        <input type="text" id="customerNumber" name="客戶編號" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入客戶編號">
                    </div>
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                        <input type="text" id="customerName" name="姓名" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入姓名">
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-2">電話</label>
                        <input type="tel" id="customerPhone" name="電話" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入電話號碼">
                    </div>
                    <div>
                        <label for="customerMobile" class="block text-sm font-medium text-gray-700 mb-2">手機</label>
                        <input type="tel" id="customerMobile" name="手機" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入手機號碼">
                    </div>
                    <div class="lg:col-span-2">
                        <label for="customerAddress" class="block text-sm font-medium text-gray-700 mb-2">地址</label>
                        <input type="text" id="customerAddress" name="地址" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入完整地址">
                    </div>
                    <div>
                        <label for="salesperson" class="block text-sm font-medium text-gray-700 mb-2">所屬業務</label>
                        <input type="text" id="salesperson" name="所屬業務" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入業務員姓名">
                    </div>
                </div>
            </div>

            <!-- 發票資訊區塊 -->
            <div class="border-l-4 border-purple-500 pl-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">發票資訊</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="invoicePrefix" class="block text-sm font-medium text-gray-700 mb-2">字軌</label>
                        <input type="text" id="invoicePrefix" name="字軌" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="請輸入字軌">
                    </div>
                    <div>
                        <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 mb-2">發票號碼</label>
                        <input type="text" id="invoiceNumber" name="發票號碼" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="請輸入發票號碼">
                    </div>
                    <div>
                        <label for="invoiceType" class="block text-sm font-medium text-gray-700 mb-2">發票型態</label>
                        <select id="invoiceType" name="發票型態" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">請選擇發票型態</option>
                            <option value="二聯式">二聯式</option>
                            <option value="三聯式">三聯式</option>
                            <option value="電子發票">電子發票</option>
                        </select>
                    </div>
                    <div>
                        <label for="invoiceTitle" class="block text-sm font-medium text-gray-700 mb-2">三聯式抬頭</label>
                        <input type="text" id="invoiceTitle" name="三聯式抬頭" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="請輸入抬頭">
                    </div>
                    <div>
                        <label for="taxId" class="block text-sm font-medium text-gray-700 mb-2">統編</label>
                        <input type="text" id="taxId" name="統編" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="請輸入統一編號">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label for="invoiceYear" class="block text-sm font-medium text-gray-700 mb-2">年</label>
                            <input type="number" id="invoiceYear" name="發票年" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="2024" min="2020" max="2030">
                        </div>
                        <div>
                            <label for="invoiceMonth" class="block text-sm font-medium text-gray-700 mb-2">月</label>
                            <input type="number" id="invoiceMonth" name="發票月" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="12" min="1" max="12">
                        </div>
                        <div>
                            <label for="invoiceDay" class="block text-sm font-medium text-gray-700 mb-2">日</label>
                            <input type="number" id="invoiceDay" name="發票日" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="31" min="1" max="31">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 金額資訊區塊 -->
            <div class="border-l-4 border-orange-500 pl-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">金額資訊</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="invoiceAmount" class="block text-sm font-medium text-gray-700 mb-2">發票金額</label>
                        <input type="number" id="invoiceAmount" name="發票金額" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="0" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="refundAmount" class="block text-sm font-medium text-gray-700 mb-2">退費金額</label>
                        <input type="number" id="refundAmount" name="退費金額" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="0" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="totalAmount" class="block text-sm font-medium text-gray-700 mb-2">總金額</label>
                        <input type="number" id="totalAmount" name="總金額" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-gray-50" placeholder="0" readonly>
                    </div>
                    <div>
                        <label for="cardLastFour" class="block text-sm font-medium text-gray-700 mb-2">卡號後四碼</label>
                        <input type="text" id="cardLastFour" name="卡號後四碼" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="****" maxlength="4">
                    </div>
                    <div>
                        <label for="authCode" class="block text-sm font-medium text-gray-700 mb-2">授權碼</label>
                        <input type="text" id="authCode" name="授權碼" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="請輸入授權碼">
                    </div>
                    <div>
                        <label for="refundType" class="block text-sm font-medium text-gray-700 mb-2">退費類別</label>
                        <select id="refundType" name="退費類別" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">請選擇退費類別</option>
                            <option value="全額退費">全額退費</option>
                            <option value="部分退費">部分退費</option>
                            <option value="手續費扣除">手續費扣除</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 詳細資訊區塊 -->
            <div class="border-l-4 border-red-500 pl-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">詳細資訊</h2>
                <div class="space-y-6">
                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-700 mb-2">會辦明細</label>
                        <textarea id="details" name="會辦明細" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="4" placeholder="請詳細說明會辦內容及退費原因"></textarea>
                    </div>
                    <div>
                        <label for="clerk" class="block text-sm font-medium text-gray-700 mb-2">製單</label>
                        <input type="text" id="clerk" name="製單" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="製單人員姓名">
                    </div>
                </div>
            </div>

            <!-- 提交按鈕 -->
            <div class="flex justify-center pt-8">
                <button type="submit" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transform transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    提交申請表單
                </button>
            </div>
        </form>
    </div>

    <script>
        // ====== Google Apps Script Web App URL ======
        const WEB_APP_URL = 'https://script.google.com/macros/library/d/1rQH5LgEB_9QQqdHnU0oe-0lQvZUzXwMT6LIH3b6IUEdNNMQoUHK08J0O/6';

        // ====== 小工具 ======
        function formatDate(date ) {
            const d = new Date(date);
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${d.getFullYear()}-${m}-${day}`;
        }

        function showMessage(message, type = 'info') {
            const div = document.createElement('div');
            div.textContent = message;
            div.style.cssText = `position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:6px;color:#fff;font-weight:700;z-index:10000;max-width:320px;word-break:break-all;background:${type==='success'?'#16a34a':type==='error'?'#dc2626':'#2563eb'};`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // ====== 主要邏輯 ======
        function calculateTotal() {
            const invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
            const refundAmount = parseFloat(document.getElementById('refundAmount').value) || 0;
            const totalAmount = invoiceAmount - refundAmount;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);
        }

        async function sendData(data) {
            try {
                const resp = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data),
                    redirect: 'follow'
                });
                if (!resp.ok) throw new Error(`HTTP 錯誤，狀態碼: ${resp.status}`);
                return await resp.json();
            } catch (err) {
                showMessage('提交失敗：' + err.message, 'error');
                return { success: false, message: err.message };
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = document.getElementById('refundForm');
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            const loadingOverlay = document.getElementById('loadingOverlay');

            // 顯示載入畫面並禁用按鈕
            loadingOverlay.style.display = 'flex';
            submitButton.disabled = true;
            submitButton.innerHTML = '處理中...';

            try {
                // 收集表單資料
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // 欄位驗證
                if (!data['製單']) {
                    showMessage('請務必填寫「製單」人員姓名', 'error');
                    return;
                }
                if (!data['客戶編號'] && !data['姓名']) {
                    showMessage('請至少填寫客戶的「客戶編號」或「姓名」', 'error');
                    return;
                }

                const res = await sendData(data);

                if (res && res.success) {
                    showMessage('申請已成功提交，後端正在處理中...', 'success');
                    form.reset();
                    calculateTotal();
                    document.getElementById('fillDate').value = formatDate(new Date());
                } else {
                    showMessage('提交失敗：' + (res?.message || '未知的後端錯誤'), 'error');
                }
            } catch (err) {
                showMessage('提交請求失敗：' + err.message, 'error');
            } finally {
                // 隱藏載入畫面並恢復按鈕
                loadingOverlay.style.display = 'none';
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 事件監聽器
            document.getElementById('invoiceAmount').addEventListener('input', calculateTotal);
            document.getElementById('refundAmount').addEventListener('input', calculateTotal);
            document.getElementById('cardLastFour').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            document.getElementById('refundForm').addEventListener('submit', handleSubmit);

            // 頁面載入時設定預設填寫日期為今天
            document.getElementById('fillDate').value = formatDate(new Date());
        });
    </script>
</body>
</html>

