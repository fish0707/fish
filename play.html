<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOP 戰情室：歷史修正計畫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .chat-scroll { scrollbar-width: thin; scrollbar-color: #475569 #1e293b; }
        .message-anim { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .sop-check { transition: all 0.3s ease; }
        .sop-checked { background-color: #059669; border-color: #059669; color: white; }
        .highlight-word { background-color: #f59e0b; color: #000; padding: 0 4px; border-radius: 2px; font-weight: bold; }
        
        /* 錄音波紋動畫 */
        .mic-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
        .mic-wave span { width: 3px; background: #ef4444; animation: wave 1s infinite ease-in-out; border-radius: 2px; }
        .mic-wave span:nth-child(1) { animation-delay: 0.1s; height: 10px; }
        .mic-wave span:nth-child(2) { animation-delay: 0.2s; height: 15px; }
        .mic-wave span:nth-child(3) { animation-delay: 0.3s; height: 20px; }
        .mic-wave span:nth-child(4) { animation-delay: 0.2s; height: 15px; }
        .mic-wave span:nth-child(5) { animation-delay: 0.1s; height: 10px; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(2); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- 頂部導航 -->
    <header class="bg-slate-900 border-b border-slate-700 h-16 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <i class="fa-solid fa-brain text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-wide">SOP 戰情室：歷史修正模式</h1>
                <p class="text-xs text-slate-400">Loading Case: 全秀惠-未成交-20260128</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-slate-800 px-4 py-2 rounded-full border border-slate-600 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                <span class="text-xs font-mono text-slate-300">REC: 00:00:00</span>
            </div>
        </div>
    </header>

    <!-- 主畫面佈局 -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- 左側：SOP 監控儀表板 -->
        <aside class="w-80 bg-slate-900 border-r border-slate-700 flex flex-col z-10">
            <div class="p-4 bg-slate-800/50 border-b border-slate-700">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">案件摘要 (Case Profile)</h2>
                <div class="space-y-3">
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-500 mb-1">客戶畫像 (Persona)</div>
                        <div class="font-bold text-sm text-white">貪小便宜的舊客</div>
                        <div class="text-xs text-indigo-400 mt-1">
                            <i class="fa-solid fa-tag mr-1"></i>盤石200元競品 
                            <i class="fa-solid fa-tag mr-1"></i>低用量
                        </div>
                    </div>
                    <div class="bg-red-900/20 p-3 rounded-lg border border-red-900/50">
                        <div class="text-xs text-red-400 mb-1">核心阻礙 (Blocker)</div>
                        <div class="text-xs text-red-200 leading-relaxed">
                            客戶深受舊業者「200元/月」影響，認為 370 元太貴，且自認需求極低 (只偶爾用)。
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">SOP 即時檢核 (Live Check)</h2>
                <div id="sop-list" class="space-y-2">
                    <!-- SOP Items (Generated by JS) -->
                </div>
            </div>
        </aside>

        <!-- 中間：歷史對話重演 (Timeline) -->
        <section class="flex-1 flex flex-col bg-slate-950 relative">
            <!-- 播放進度條 -->
            <div class="h-1 bg-slate-800 w-full">
                <div id="progress-bar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
            </div>

            <!-- 對話區 -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6 chat-scroll pb-32">
                <!-- Messages Injected Here -->
            </div>

            <!-- 介入控制台 (Intervention Console) -->
            <div id="control-panel" class="absolute bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 p-6 shadow-2xl transform transition-transform duration-300 translate-y-0">
                
                <!-- 狀態 1: 自動播放中 -->
                <div id="status-playing" class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <button onclick="togglePlay()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white transition">
                            <i id="play-icon" class="fa-solid fa-pause"></i>
                        </button>
                        <div>
                            <div class="text-sm font-bold text-white">正在重演歷史錄音...</div>
                            <div class="text-xs text-slate-400">AI 正在監測對話品質</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400">倍速: 1.0x</span>
                    </div>
                </div>

                <!-- 狀態 2: 需要介入 (暫停時顯示) -->
                <div id="status-intervention" class="hidden">
                    <div class="flex items-start gap-4 mb-4">
                        <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i>
                        </div>
                        <div>
                            <h3 class="text-yellow-400 font-bold text-sm">偵測到關鍵缺失！(Critical Error)</h3>
                            <p class="text-slate-300 text-sm mt-1">專員在此處未能有效處理「價格異議」。請參考右側金牌話術，按下麥克風進行修正。</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <input type="text" id="user-input" placeholder="請輸入正確的應對話術..." class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 text-white focus:border-indigo-500 focus:outline-none">
                        <button onclick="toggleMic()" id="mic-btn" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold flex items-center gap-2 border border-slate-600">
                            <i class="fa-solid fa-microphone"></i> 錄音
                        </button>
                        <button onclick="submitIntervention()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg shadow-indigo-500/20">
                            確認修正
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 右側：教練視角與金牌樣本 -->
        <aside class="w-96 bg-slate-900 border-l border-slate-700 flex flex-col">
            <!-- 頁籤 -->
            <div class="flex border-b border-slate-700">
                <button class="flex-1 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500 bg-slate-800/50">
                    <i class="fa-solid fa-star mr-1"></i> 金牌樣本 (Success)
                </button>
                <button class="flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300">
                    <i class="fa-solid fa-file-medical mr-1"></i> KB 診斷
                </button>
            </div>

            <!-- 內容區 -->
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                
                <!-- 提示卡片 -->
                <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xs font-bold text-indigo-300 uppercase">參考：劉亭君 (成交案)</h3>
                        <span class="bg-green-500/20 text-green-400 text-[10px] px-2 py-0.5 rounded">High Score</span>
                    </div>
                    <div class="text-sm text-slate-300 leading-relaxed italic">
                        "大哥，其實您換算下來，370元一天只要 <span class="text-white font-bold underline decoration-yellow-500">12塊錢</span>，比買一瓶養樂多還便宜，而且我們是專線，尖峰時間不會塞車。"
                    </div>
                    <div class="mt-3 flex gap-2">
                        <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400">#價值堆疊</span>
                        <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400">#日單價拆解</span>
                    </div>
                </div>

                <!-- 診斷分析 (來自您的 CSV/PDF) -->
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">AI 診斷與分析</h3>
                    <div class="space-y-3">
                        <div class="flex gap-3">
                            <div class="mt-1"><i class="fa-solid fa-xmark text-red-500"></i></div>
                            <div>
                                <div class="text-xs font-bold text-slate-200">未執行價值墊高</div>
                                <div class="text-xs text-slate-500 mt-0.5">面對 200 元競品，僅回答「這是最優惠了」，未拆解日費用來降低客戶痛感。</div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="mt-1"><i class="fa-solid fa-xmark text-red-500"></i></div>
                            <div>
                                <div class="text-xs font-bold text-slate-200">SOP 違規</div>
                                <div class="text-xs text-slate-500 mt-0.5">使用了負面詞彙「沒辦法」，應改為強調 300M 的「穩定性優勢」。</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </aside>

    </main>

    <!-- JS Logic -->
    <script>
        // --- 資料結構：整合您的 TXT 檔案 ---
        
        // 1. SOP 檢核表 (來自 PDF/CSV)
        const sopItems = [
            { id: 1, text: "開場：報姓氏與問候", status: "pending" },
            { id: 2, text: "探詢：確認社區與需求", status: "pending" },
            { id: 3, text: "報價：清楚說明費用結構", status: "pending" },
            { id: 4, text: "異議處理：價值堆疊 (日單價)", status: "pending" }, // 關鍵缺失點
            { id: 5, text: "締結：提及 10 天鑑賞期", status: "pending" }
        ];

        // 2. 劇本流程 (基於「全秀惠-未成交」與「劉亭君-成交」整合)
        const scriptFlow = [
            {
                role: "agent", text: "謝謝您，您好，敝姓陳，很高興為您服務。",
                audioTime: 3000, sopId: 1, status: "pass"
            },
            {
                role: "customer", text: "我請問一下，你們網路只有那種 300M... 300M 的那個社區方案嗎？有沒有更低的啊？因為我不用用到那麼多，我只是偶爾用。",
                audioTime: 5000
            },
            {
                role: "agent", text: "我目前的話都統一建設到上傳下載都是 300M 的頻寬喔。",
                audioTime: 3000, sopId: 2, status: "warning", // 這裡只是回答規格，未探詢
                coachNote: "僅回答規格，未探詢用途。"
            },
            {
                role: "customer", text: "啊...那沒有再優惠的了喔？我在別家才 200 塊。",
                audioTime: 4000
            },
            {
                // 這就是關鍵失敗點，系統會在這裡暫停
                role: "agent", text: "對，這是最優惠的...每個月平均大概是 428 元...真的沒有辦法再低了。",
                audioTime: 4000, sopId: 4, status: "fail",
                isBreakpoint: true, // 標記為介入點
                coachNote: "未執行價值墊高，且使用了負面詞彙。"
            }
        ];

        // --- 程式邏輯 ---

        let currentStep = 0;
        let isPlaying = false;
        let playInterval;

        function init() {
            renderSOP();
            // Start the simulation after a short delay
            setTimeout(() => {
                addSystemMessage("系統連線中... 載入案件：全秀惠-未成交 (2026/01/28)");
                startPlayback();
            }, 1000);
        }

        function renderSOP() {
            const container = document.getElementById('sop-list');
            container.innerHTML = sopItems.map(item => `
                <div id="sop-item-${item.id}" class="sop-check border border-slate-700 bg-slate-800/50 p-3 rounded flex items-center justify-between">
                    <span class="text-xs text-slate-300">${item.text}</span>
                    <i class="fa-regular fa-circle text-slate-600 text-xs icon"></i>
                </div>
            `).join('');
        }

        function updateSOP(id, status) {
            const el = document.getElementById(`sop-item-${id}`);
            const icon = el.querySelector('.icon');
            if (status === 'pass') {
                el.className = "sop-check border border-green-600 bg-green-900/30 p-3 rounded flex items-center justify-between";
                icon.className = "fa-solid fa-check text-green-400 text-xs icon";
            } else if (status === 'fail') {
                el.className = "sop-check border border-red-600 bg-red-900/30 p-3 rounded flex items-center justify-between";
                icon.className = "fa-solid fa-xmark text-red-400 text-xs icon";
            }
        }

        function startPlayback() {
            isPlaying = true;
            document.getElementById('play-icon').className = "fa-solid fa-pause";
            
            // 模擬逐句播放
            playNextLine();
        }

        function togglePlay() {
            if (isPlaying) {
                isPlaying = false;
                document.getElementById('play-icon').className = "fa-solid fa-play";
                clearTimeout(playInterval);
            } else {
                startPlayback();
            }
        }

        function playNextLine() {
            if (currentStep >= scriptFlow.length || !isPlaying) return;

            const line = scriptFlow[currentStep];
            
            // 1. 如果是介入點 (Breakpoint)，暫停並切換 UI
            if (line.isBreakpoint) {
                isPlaying = false;
                showInterventionUI();
                // 顯示原本失敗的對話，但標示為錯誤
                addMessage(line.role, line.text, 'fail');
                updateSOP(line.sopId, 'fail');
                return;
            }

            // 2. 顯示對話
            addMessage(line.role, line.text, line.status || 'neutral');
            
            // 3. 更新 SOP 狀態
            if (line.sopId) {
                updateSOP(line.sopId, line.status);
            }

            // 4. 排程下一句
            currentStep++;
            playInterval = setTimeout(playNextLine, line.audioTime);
            updateProgressBar();
        }

        function addMessage(role, text, status) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            
            // Styles based on role
            let bubbleClass = "";
            let alignClass = "";
            let avatar = "";

            if (role === 'system') {
                div.className = "flex justify-center message-anim";
                div.innerHTML = `<span class="text-xs bg-slate-800 text-slate-400 px-3 py-1 rounded-full border border-slate-700">${text}</span>`;
                container.appendChild(div);
                return;
            }

            if (role === 'customer') {
                alignClass = "justify-start";
                bubbleClass = "bg-slate-800 text-slate-200 border-slate-700";
                avatar = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-400">客</div>`;
            } else { // Agent
                alignClass = "justify-end";
                if (status === 'fail') {
                    bubbleClass = "bg-red-900/40 text-red-100 border-red-800"; // 錯誤示範
                } else if (status === 'fixed') {
                    bubbleClass = "bg-green-600 text-white border-green-500"; // 修正後
                } else {
                    bubbleClass = "bg-indigo-600 text-white border-indigo-500";
                }
                avatar = `<div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold text-white">員</div>`;
            }

            div.className = `flex ${alignClass} gap-3 message-anim`;
            
            // Layout logic
            const content = `
                <div class="${bubbleClass} border px-4 py-3 rounded-2xl max-w-[80%] text-sm shadow-sm leading-relaxed relative group">
                    ${text}
                    ${status === 'fail' ? '<div class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">失誤點</div>' : ''}
                </div>
            `;

            div.innerHTML = role === 'customer' ? avatar + content : content + avatar;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            addMessage('system', text);
        }

        function showInterventionUI() {
            document.getElementById('status-playing').classList.add('hidden');
            document.getElementById('status-intervention').classList.remove('hidden');
            document.getElementById('control-panel').classList.add('border-red-500'); // Highlight border
        }

        function submitIntervention() {
            const input = document.getElementById('user-input');
            const text = input.value;
            if (!text) return;

            // 1. 隱藏介入 UI，恢復正常
            document.getElementById('status-playing').classList.remove('hidden');
            document.getElementById('status-intervention').classList.add('hidden');
            document.getElementById('control-panel').classList.remove('border-red-500');

            // 2. 顯示修正後的對話
            addMessage('agent', text, 'fixed');
            updateSOP(4, 'pass'); // 修正 SOP 狀態

            // 3. AI 給予回饋 (模擬)
            setTimeout(() => {
                addSystemMessage("AI 判定：成功運用「日單價」概念，通過檢核！");
                
                // 4. 繼續播放「如果成功了會怎樣」的模擬後續
                // 這裡使用劉亭君(成交案)的後續作為獎勵
                setTimeout(() => {
                    addMessage('customer', "喔...一天12塊喔？這樣聽起來好像比較划算。那你們有鑑賞期嗎？", 'neutral');
                    currentStep++;
                    isPlaying = true;
                    // Resume playback logic if needed...
                }, 1500);
            }, 800);
        }
        
        function updateProgressBar() {
            const progress = (currentStep / scriptFlow.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        // --- Mock Mic Logic ---
        function toggleMic() {
            const btn = document.getElementById('mic-btn');
            if (btn.classList.contains('bg-red-600')) {
                btn.classList.remove('bg-red-600', 'animate-pulse');
                btn.classList.add('bg-slate-700');
                btn.innerHTML = '<i class="fa-solid fa-microphone"></i> 錄音';
                document.getElementById('user-input').value = "這370元換算下來一天只要12塊，比養樂多還便宜，而且保證不塞車。"; // Auto-fill mock text
            } else {
                btn.classList.add('bg-red-600', 'animate-pulse');
                btn.classList.remove('bg-slate-700');
                btn.innerHTML = '<div class="mic-wave"><span></span><span></span><span></span><span></span><span></span></div> 錄音中';
            }
        }

        // Init
        window.onload = init;

    </script>
</body>
</html>
